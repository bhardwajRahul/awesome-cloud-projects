{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Cross-Tenant Resource Governance Dashboard\n\nThis workbook provides comprehensive monitoring and governance insights across all managed customer tenants through Azure Lighthouse.\n\n---"
      },
      "name": "title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "1f74ed9a-e3ed-498d-bd5b-f68f3836a117",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "description": "Select the time range for the dashboard",
            "isRequired": true,
            "value": {
              "durationMs": 3600000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Heartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer, Category\r\n| extend Status = case(LastHeartbeat > ago(2m), \"Healthy\", \"Unhealthy\")\r\n| summarize Healthy = countif(Status == \"Healthy\"), Unhealthy = countif(Status == \"Unhealthy\")\r\n| extend Total = Healthy + Unhealthy\r\n| project Status = \"Total\", Healthy, Unhealthy, Total\r\n| union (\r\n    Heartbeat\r\n    | where TimeGenerated {TimeRange:query}\r\n    | summarize LastHeartbeat = max(TimeGenerated) by Computer, Category\r\n    | extend Status = case(LastHeartbeat > ago(2m), \"Healthy\", \"Unhealthy\")\r\n    | summarize count() by Status\r\n    | evaluate pivot(Status)\r\n    | project Status = \"Details\", Healthy = coalesce(Healthy, 0), Unhealthy = coalesce(Unhealthy, 0), Total = Healthy + Unhealthy\r\n)",
        "size": 1,
        "title": "VM Health Status Across All Tenants",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Status",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Healthy",
            "formatter": 12,
            "formatOptions": {
              "palette": "green"
            }
          },
          "secondaryContent": {
            "columnMatch": "Total",
            "formatter": 1
          },
          "showBorder": false
        }
      },
      "name": "vm-health-tiles"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Perf\r\n| where TimeGenerated {TimeRange:query}\r\n| where CounterName == \"% Processor Time\" and InstanceName == \"_Total\"\r\n| summarize AvgCPU = avg(CounterValue) by Computer, bin(TimeGenerated, 5m)\r\n| render timechart",
        "size": 0,
        "title": "CPU Usage Across All Managed VMs",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "cpu-usage-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Perf\r\n| where TimeGenerated {TimeRange:query}\r\n| where CounterName == \"Available MBytes\"\r\n| summarize AvailableMemoryMB = avg(CounterValue) by Computer, bin(TimeGenerated, 5m)\r\n| render timechart",
        "size": 0,
        "title": "Available Memory Across All Managed VMs",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "memory-usage-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Event\r\n| where TimeGenerated {TimeRange:query}\r\n| where EventLevelName in (\"Error\", \"Warning\")\r\n| summarize Count = count() by Computer, EventLevelName, bin(TimeGenerated, 1h)\r\n| render barchart",
        "size": 0,
        "title": "Error and Warning Events",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "error-warning-events"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Update\r\n| where TimeGenerated {TimeRange:query}\r\n| where UpdateState == \"Needed\"\r\n| summarize PendingUpdates = count() by Computer, Classification\r\n| order by PendingUpdates desc",
        "size": 0,
        "title": "Pending Updates by Computer",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table"
      },
      "name": "pending-updates-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "SecurityEvent\r\n| where TimeGenerated {TimeRange:query}\r\n| where EventID in (4624, 4625, 4648, 4768, 4769, 4771, 4776, 4778, 4779)\r\n| summarize Count = count() by Computer, EventID, bin(TimeGenerated, 1h)\r\n| join kind=leftouter (\r\n    datatable(EventID:int, EventDescription:string)\r\n    [\r\n        4624, \"Successful Logon\",\r\n        4625, \"Failed Logon\",\r\n        4648, \"Logon with Explicit Credentials\",\r\n        4768, \"Kerberos TGT Requested\",\r\n        4769, \"Kerberos Service Ticket Requested\",\r\n        4771, \"Kerberos Pre-auth Failed\",\r\n        4776, \"NTLM Authentication\",\r\n        4778, \"Session Reconnected\",\r\n        4779, \"Session Disconnected\"\r\n    ]\r\n) on EventID\r\n| project TimeGenerated, Computer, EventDescription, Count\r\n| render columnchart",
        "size": 0,
        "title": "Security Events Overview",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "security-events-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ConfigurationChange\r\n| where TimeGenerated {TimeRange:query}\r\n| where ConfigChangeType in (\"Software\", \"Services\", \"Registry\")\r\n| summarize Changes = count() by Computer, ConfigChangeType, bin(TimeGenerated, 1h)\r\n| render timechart",
        "size": 0,
        "title": "Configuration Changes",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "config-changes-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Heartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer, OSType, ComputerEnvironment\r\n| extend Status = case(LastHeartbeat > ago(2m), \"Online\", \"Offline\")\r\n| extend LastSeen = case(Status == \"Online\", \"Now\", strcat(datetime_diff(\"minute\", now(), LastHeartbeat), \" minutes ago\"))\r\n| project Computer, OSType, ComputerEnvironment, Status, LastSeen\r\n| order by Status desc, Computer asc",
        "size": 0,
        "title": "Managed Computers Status",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Online",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Offline",
                    "representation": "failed",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "unknown",
                    "text": "{0}{1}"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "computers-status-table"
    },
    {
      "type": 1,
      "content": {
        "json": "## Automanage Status\n\nThis section shows the status of Azure Automanage across all managed virtual machines."
      },
      "name": "automanage-section-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Simulated Automanage status query\r\n// In a real environment, this would query actual Automanage logs\r\nHeartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer\r\n| extend AutomanageStatus = case(\r\n    LastHeartbeat > ago(5m), \"Compliant\",\r\n    LastHeartbeat > ago(15m), \"Warning\",\r\n    \"Non-Compliant\"\r\n)\r\n| summarize count() by AutomanageStatus\r\n| render piechart",
        "size": 0,
        "title": "Automanage Compliance Status",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "automanage-compliance-chart"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}