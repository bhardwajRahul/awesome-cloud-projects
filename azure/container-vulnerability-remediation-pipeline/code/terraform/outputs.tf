# Resource Group Outputs
output "resource_group_name" {
  description = "Name of the created resource group"
  value       = azurerm_resource_group.container_security.name
}

output "resource_group_id" {
  description = "ID of the created resource group"
  value       = azurerm_resource_group.container_security.id
}

output "location" {
  description = "Azure region where resources are deployed"
  value       = azurerm_resource_group.container_security.location
}

# Container Registry Outputs
output "container_registry_name" {
  description = "Name of the Azure Container Registry"
  value       = azurerm_container_registry.container_security.name
}

output "container_registry_id" {
  description = "ID of the Azure Container Registry"
  value       = azurerm_container_registry.container_security.id
}

output "container_registry_login_server" {
  description = "Login server URL for the Azure Container Registry"
  value       = azurerm_container_registry.container_security.login_server
}

output "container_registry_admin_username" {
  description = "Admin username for the Azure Container Registry"
  value       = azurerm_container_registry.container_security.admin_username
  sensitive   = true
}

output "container_registry_admin_password" {
  description = "Admin password for the Azure Container Registry"
  value       = azurerm_container_registry.container_security.admin_password
  sensitive   = true
}

# Key Vault Outputs
output "key_vault_name" {
  description = "Name of the Azure Key Vault"
  value       = azurerm_key_vault.container_security.name
}

output "key_vault_id" {
  description = "ID of the Azure Key Vault"
  value       = azurerm_key_vault.container_security.id
}

output "key_vault_uri" {
  description = "URI of the Azure Key Vault"
  value       = azurerm_key_vault.container_security.vault_uri
}

# Log Analytics Workspace Outputs
output "log_analytics_workspace_name" {
  description = "Name of the Log Analytics workspace"
  value       = azurerm_log_analytics_workspace.container_security.name
}

output "log_analytics_workspace_id" {
  description = "ID of the Log Analytics workspace"
  value       = azurerm_log_analytics_workspace.container_security.id
}

output "log_analytics_workspace_workspace_id" {
  description = "Workspace ID of the Log Analytics workspace"
  value       = azurerm_log_analytics_workspace.container_security.workspace_id
}

output "log_analytics_workspace_primary_shared_key" {
  description = "Primary shared key of the Log Analytics workspace"
  value       = azurerm_log_analytics_workspace.container_security.primary_shared_key
  sensitive   = true
}

# Service Principal Outputs
output "service_principal_application_id" {
  description = "Application ID of the service principal"
  value       = azuread_application.devops_app.application_id
}

output "service_principal_object_id" {
  description = "Object ID of the service principal"
  value       = azuread_service_principal.devops_sp.object_id
}

output "service_principal_display_name" {
  description = "Display name of the service principal"
  value       = azuread_service_principal.devops_sp.display_name
}

# Azure DevOps Project Outputs
output "azdo_project_id" {
  description = "ID of the Azure DevOps project"
  value       = azuredevops_project.container_security.id
}

output "azdo_project_name" {
  description = "Name of the Azure DevOps project"
  value       = azuredevops_project.container_security.name
}

output "azdo_project_url" {
  description = "URL of the Azure DevOps project"
  value       = azuredevops_project.container_security.project_url
}

output "azdo_service_connection_id" {
  description = "ID of the Azure DevOps service connection"
  value       = azuredevops_serviceendpoint_azurerm.container_security.id
}

output "azdo_variable_group_id" {
  description = "ID of the Azure DevOps variable group"
  value       = azuredevops_variable_group.container_security.id
}

# Network Resources Outputs
output "virtual_network_name" {
  description = "Name of the virtual network"
  value       = azurerm_virtual_network.container_security.name
}

output "virtual_network_id" {
  description = "ID of the virtual network"
  value       = azurerm_virtual_network.container_security.id
}

output "subnet_name" {
  description = "Name of the container security subnet"
  value       = azurerm_subnet.container_security.name
}

output "subnet_id" {
  description = "ID of the container security subnet"
  value       = azurerm_subnet.container_security.id
}

# Monitoring and Alerting Outputs
output "action_group_id" {
  description = "ID of the monitoring action group"
  value       = var.enable_security_alerts ? azurerm_monitor_action_group.container_vulnerabilities[0].id : null
}

output "metric_alert_id" {
  description = "ID of the metric alert for critical vulnerabilities"
  value       = var.enable_security_alerts ? azurerm_monitor_metric_alert.container_critical_vulnerabilities[0].id : null
}

output "scheduled_query_rule_id" {
  description = "ID of the scheduled query rule for vulnerability trend analysis"
  value       = var.enable_security_alerts ? azurerm_monitor_scheduled_query_rules_alert.vulnerability_trend_analysis[0].id : null
}

# Policy Outputs
output "vulnerability_policy_definition_id" {
  description = "ID of the vulnerability assessment policy definition"
  value       = var.enable_vulnerability_policy ? azurerm_policy_definition.container_vulnerability_assessment[0].id : null
}

output "image_age_policy_definition_id" {
  description = "ID of the image age limit policy definition"
  value       = var.enable_image_age_policy ? azurerm_policy_definition.container_image_age_limit[0].id : null
}

output "vulnerability_policy_assignment_id" {
  description = "ID of the vulnerability assessment policy assignment"
  value       = var.enable_vulnerability_policy ? azurerm_policy_assignment.container_vulnerability_assessment[0].id : null
}

output "image_age_policy_assignment_id" {
  description = "ID of the image age limit policy assignment"
  value       = var.enable_image_age_policy ? azurerm_policy_assignment.container_image_age_limit[0].id : null
}

# Security Outputs
output "defender_container_registry_enabled" {
  description = "Whether Microsoft Defender for Container Registries is enabled"
  value       = var.enable_defender_for_containers
}

output "defender_pricing_tier" {
  description = "Pricing tier for Microsoft Defender for Container Registries"
  value       = var.enable_defender_for_containers ? var.defender_pricing_tier : null
}

# Deployment Information
output "deployment_info" {
  description = "Key information for post-deployment configuration"
  value = {
    container_registry_url   = azurerm_container_registry.container_security.login_server
    key_vault_name          = azurerm_key_vault.container_security.name
    log_analytics_workspace = azurerm_log_analytics_workspace.container_security.workspace_id
    resource_group_name     = azurerm_resource_group.container_security.name
    service_principal_id    = azuread_application.devops_app.application_id
    azdo_project_name       = azuredevops_project.container_security.name
    azdo_project_url        = azuredevops_project.container_security.project_url
  }
}

# Connection Strings and Configuration
output "container_registry_connection_string" {
  description = "Connection string for the Azure Container Registry"
  value       = "DefaultEndpointsProtocol=https;AccountName=${azurerm_container_registry.container_security.name};AccountKey=${azurerm_container_registry.container_security.admin_password};EndpointSuffix=core.windows.net"
  sensitive   = true
}

output "log_analytics_connection_string" {
  description = "Connection string for the Log Analytics workspace"
  value       = "InstrumentationKey=${azurerm_log_analytics_workspace.container_security.workspace_id};IngestionEndpoint=https://${azurerm_log_analytics_workspace.container_security.location}.monitoring.azure.com/"
  sensitive   = true
}

# CLI Commands for Post-Deployment
output "cli_commands" {
  description = "Useful CLI commands for post-deployment configuration"
  value = {
    acr_login               = "az acr login --name ${azurerm_container_registry.container_security.name}"
    docker_build_and_push   = "docker build -t ${azurerm_container_registry.container_security.login_server}/myapp:latest . && docker push ${azurerm_container_registry.container_security.login_server}/myapp:latest"
    view_vulnerabilities    = "az acr repository show-manifests --name ${azurerm_container_registry.container_security.name} --repository myapp --detail"
    check_policy_compliance = "az policy state list --resource-group ${azurerm_resource_group.container_security.name}"
  }
}

# URLs for Quick Access
output "quick_access_urls" {
  description = "URLs for quick access to created resources"
  value = {
    azure_portal_resource_group = "https://portal.azure.com/#@${data.azurerm_client_config.current.tenant_id}/resource/subscriptions/${data.azurerm_client_config.current.subscription_id}/resourceGroups/${azurerm_resource_group.container_security.name}/overview"
    azure_portal_container_registry = "https://portal.azure.com/#@${data.azurerm_client_config.current.tenant_id}/resource${azurerm_container_registry.container_security.id}/overview"
    azure_portal_key_vault = "https://portal.azure.com/#@${data.azurerm_client_config.current.tenant_id}/resource${azurerm_key_vault.container_security.id}/overview"
    azure_portal_log_analytics = "https://portal.azure.com/#@${data.azurerm_client_config.current.tenant_id}/resource${azurerm_log_analytics_workspace.container_security.id}/overview"
    azdo_project_url = azuredevops_project.container_security.project_url
  }
}