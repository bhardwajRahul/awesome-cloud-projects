# Infrastructure as Code for Container Vulnerability Remediation Pipeline with DevSecOps

This directory contains Infrastructure as Code (IaC) implementations for the recipe "Container Vulnerability Remediation Pipeline with DevSecOps".

## Available Implementations

- **Bicep**: Azure native infrastructure as code (recommended)
- **Terraform**: Multi-cloud infrastructure as code
- **Scripts**: Bash deployment and cleanup scripts

## Prerequisites

- Azure CLI v2.50.0 or later installed and configured
- Azure subscription with Owner or Contributor access
- Azure DevOps organization with project creation permissions
- Docker CLI installed for local image testing
- Appropriate permissions for resource creation:
  - Microsoft.ContainerRegistry/* permissions
  - Microsoft.DevOps/* permissions
  - Microsoft.KeyVault/* permissions
  - Microsoft.Policy/* permissions
  - Microsoft.Monitor/* permissions
  - Microsoft.OperationalInsights/* permissions

## Quick Start

### Using Bicep (Recommended)

```bash
# Navigate to Bicep directory
cd bicep/

# Review and customize parameters
cp parameters.json.example parameters.json
# Edit parameters.json with your values

# Deploy infrastructure
az deployment group create \
    --resource-group rg-container-security \
    --template-file main.bicep \
    --parameters @parameters.json
```

### Using Terraform

```bash
# Navigate to Terraform directory
cd terraform/

# Initialize Terraform
terraform init

# Review and customize variables
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values

# Plan deployment
terraform plan

# Apply infrastructure
terraform apply
```

### Using Bash Scripts

```bash
# Make scripts executable
chmod +x scripts/deploy.sh
chmod +x scripts/destroy.sh

# Deploy infrastructure
./scripts/deploy.sh

# Follow prompts for configuration values
```

## Architecture Overview

This infrastructure deployment creates:

- **Azure Container Registry** (Premium tier) with vulnerability scanning
- **Azure Key Vault** for secure credential storage
- **Azure DevOps Project** with automated pipelines
- **Azure Policy** assignments for container security compliance
- **Azure Monitor** alerts and Log Analytics workspace
- **Service Principal** for DevOps authentication
- **Automated pipelines** for vulnerability scanning and remediation

## Configuration Parameters

### Key Parameters to Customize

| Parameter | Description | Default | Required |
|-----------|-------------|---------|----------|
| `resourceGroupName` | Name of the resource group | `rg-container-security` | Yes |
| `location` | Azure region for resources | `eastus` | Yes |
| `acrName` | Container Registry name (globally unique) | `acrcontainersec{random}` | Yes |
| `keyVaultName` | Key Vault name (globally unique) | `kv-containersec-{random}` | Yes |
| `workspaceName` | Log Analytics workspace name | `law-container-security` | Yes |
| `devopsOrgUrl` | Azure DevOps organization URL | - | Yes |
| `devopsProjectName` | DevOps project name | `container-security-automation` | Yes |

### Security Configuration

The deployment automatically configures:
- Container Registry with Microsoft Defender integration
- Key Vault with RBAC authorization
- Service Principal with least privilege access
- Azure Policy for vulnerability compliance
- Monitor alerts for critical vulnerabilities

## Post-Deployment Configuration

### 1. Configure Azure DevOps Service Connection

```bash
# Get service principal details from Key Vault
SP_APP_ID=$(az keyvault secret show \
    --vault-name ${KEY_VAULT_NAME} \
    --name "devops-sp-appid" \
    --query value -o tsv)

SP_PASSWORD=$(az keyvault secret show \
    --vault-name ${KEY_VAULT_NAME} \
    --name "devops-sp-password" \
    --query value -o tsv)

# Configure service connection in Azure DevOps
az devops service-endpoint azurerm create \
    --azure-rm-service-principal-id ${SP_APP_ID} \
    --azure-rm-subscription-id $(az account show --query id -o tsv) \
    --azure-rm-subscription-name "$(az account show --query name -o tsv)" \
    --azure-rm-tenant-id $(az account show --query tenantId -o tsv) \
    --name "azure-container-security" \
    --project ${DEVOPS_PROJECT_NAME}
```

### 2. Set Up Variable Groups

```bash
# Create variable group for pipeline configuration
az pipelines variable-group create \
    --name "container-security-vars" \
    --variables \
        ACR_NAME=${ACR_NAME} \
        KEY_VAULT_NAME=${KEY_VAULT_NAME} \
        RESOURCE_GROUP=${RESOURCE_GROUP_NAME} \
    --project ${DEVOPS_PROJECT_NAME}
```

### 3. Import Pipeline Templates

The bash scripts will automatically create the following pipelines:
- **vulnerability-scanning**: Automated Trivy scanning
- **vulnerability-remediation**: Copa-based patching
- **validation-deployment**: Testing and AKS deployment

## Validation

### Verify Infrastructure Deployment

```bash
# Check Container Registry status
az acr show \
    --name ${ACR_NAME} \
    --resource-group ${RESOURCE_GROUP_NAME} \
    --query "{Name:name, LoginServer:loginServer, Sku:sku.name, Status:provisioningState}"

# Verify Key Vault access
az keyvault secret list \
    --vault-name ${KEY_VAULT_NAME} \
    --query "[].{Name:name, Enabled:attributes.enabled}"

# Check Policy assignments
az policy assignment list \
    --resource-group ${RESOURCE_GROUP_NAME} \
    --query "[].{Name:displayName, PolicyDefinition:policyDefinitionId, ComplianceState:complianceState}"

# Verify Monitor alerts
az monitor metrics alert list \
    --resource-group ${RESOURCE_GROUP_NAME} \
    --query "[].{Name:name, Severity:severity, Enabled:enabled}"
```

### Test Vulnerability Scanning

```bash
# Push a test image to trigger scanning
docker pull vulnerables/web-dvwa:latest
docker tag vulnerables/web-dvwa:latest ${ACR_NAME}.azurecr.io/test/vulnerable-app:v1.0

az acr login --name ${ACR_NAME}
docker push ${ACR_NAME}.azurecr.io/test/vulnerable-app:v1.0

# Monitor scan results
az acr repository show \
    --name ${ACR_NAME} \
    --repository test/vulnerable-app \
    --query "imageManifests[0].vulnerabilities"
```

## Cleanup

### Using Bicep

```bash
# Delete the resource group (removes all resources)
az group delete \
    --name rg-container-security \
    --yes \
    --no-wait

# Remove service principal
az ad sp delete \
    --id $(az keyvault secret show \
        --vault-name ${KEY_VAULT_NAME} \
        --name "devops-sp-appid" \
        --query value -o tsv)
```

### Using Terraform

```bash
# Navigate to Terraform directory
cd terraform/

# Destroy infrastructure
terraform destroy

# Confirm destruction when prompted
```

### Using Bash Scripts

```bash
# Run cleanup script
./scripts/destroy.sh

# Follow prompts for confirmation
```

## Troubleshooting

### Common Issues

1. **Container Registry name conflicts**
   - Solution: Use a more unique suffix or different naming pattern

2. **Key Vault access denied**
   - Solution: Ensure your account has Key Vault Contributor role

3. **DevOps service connection failures**
   - Solution: Verify service principal permissions and organization access

4. **Policy assignment conflicts**
   - Solution: Remove existing policy assignments before deployment

### Debug Commands

```bash
# Check deployment logs
az deployment group list \
    --resource-group ${RESOURCE_GROUP_NAME} \
    --query "[].{Name:name, State:properties.provisioningState, Timestamp:properties.timestamp}"

# View detailed error messages
az deployment group show \
    --resource-group ${RESOURCE_GROUP_NAME} \
    --name ${DEPLOYMENT_NAME} \
    --query "properties.error"

# Check resource provisioning status
az resource list \
    --resource-group ${RESOURCE_GROUP_NAME} \
    --query "[].{Name:name, Type:type, State:provisioningState}"
```

## Security Considerations

### Network Security
- Container Registry uses private endpoints where configured
- Key Vault restricts access to authorized networks
- Service Principal uses least privilege principles

### Data Protection
- All secrets stored in Azure Key Vault
- Container images encrypted at rest
- Vulnerability scan results logged to secure workspace

### Compliance
- Azure Policy enforces security standards
- All resources tagged for governance
- Audit logs captured in Azure Monitor

## Cost Optimization

### Resource Sizing
- Container Registry Premium tier: ~$500/month
- Key Vault transactions: ~$5/month
- Log Analytics workspace: ~$50/month for 5GB
- DevOps hosted agents: ~$40/month per agent

### Cost Reduction Tips
1. Use Azure DevOps self-hosted agents for lower costs
2. Configure Log Analytics data retention policies
3. Implement Container Registry retention policies
4. Use Azure Reserved Instances for predictable workloads

## Customization

### Adding Additional Scanning Tools

Modify the pipeline templates to include:
- **Snyk**: Commercial vulnerability scanner
- **Anchore**: Open-source container analysis
- **Clair**: Static analysis for vulnerabilities

### Extending to Multi-Region

1. Deploy Container Registry with geo-replication
2. Configure cross-region DevOps agents
3. Implement regional policy assignments
4. Set up distributed monitoring

### Integration with Existing Systems

- **SIEM Integration**: Forward logs to Azure Sentinel
- **Ticketing Systems**: Connect alerts to ServiceNow/Jira
- **Slack/Teams**: Add webhook notifications to pipelines

## Support

For issues with this infrastructure code:
1. Check the troubleshooting section above
2. Review the original recipe documentation
3. Consult Azure Container Registry documentation
4. Refer to Azure DevOps pipeline documentation

## Contributing

To improve this infrastructure code:
1. Test changes in a development environment
2. Validate against the original recipe requirements
3. Ensure compatibility with all deployment methods
4. Update documentation accordingly

## License

This infrastructure code is provided as-is for educational and demonstration purposes. Refer to your organization's policies for production use.