AWSTemplateFormatVersion: '2010-09-09'
Description: >
  High-Performance File Systems with Amazon FSx - Production-Ready Template
  Creates FSx for Lustre, Windows File Server, and NetApp ONTAP file systems with comprehensive
  monitoring, security, backup, and performance optimization features. Includes CloudWatch
  dashboards, automated alarms, and proper IAM roles for production workloads.
  
  **WARNING: This template creates billable AWS resources. Review costs before deployment.**
  
  Cost Estimates (per month, approximate):
  - FSx Lustre (1200GB): ~$150-300
  - FSx Windows (32GB): ~$50-100  
  - FSx ONTAP (1024GB): ~$200-400
  - Total estimated cost: $400-800/month depending on throughput settings

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcId
          - SubnetIds
          - AllowedCidrBlock
      - Label:
          default: "FSx Configuration"
        Parameters:
          - LustreStorageCapacity
          - LustrePerUnitStorageThroughput
          - WindowsStorageCapacity
          - WindowsThroughputCapacity
          - OntapStorageCapacity
          - OntapThroughputCapacity
      - Label:
          default: "Storage Configuration"
        Parameters:
          - S3BucketName
          - NfsVolumeSize
          - SmbVolumeSize
      - Label:
          default: "Security Configuration"
        Parameters:
          - FsxAdminPassword
          - SvmAdminPassword
          - EnableEncryption
      - Label:
          default: "Monitoring Configuration"
        Parameters:
          - EnableCloudWatchAlarms
          - AlarmNotificationEmail
      - Label:
          default: "Backup Configuration"
        Parameters:
          - EnableAutomatedBackups
          - BackupRetentionDays
      - Label:
          default: "Resource Naming"
        Parameters:
          - ResourcePrefix
    ParameterLabels:
      VpcId:
        default: "VPC ID"
      SubnetIds:
        default: "Subnet IDs"
      AllowedCidrBlock:
        default: "Allowed CIDR Block"
      LustreStorageCapacity:
        default: "Lustre Storage Capacity (GB)"
      LustrePerUnitStorageThroughput:
        default: "Lustre Per-Unit Storage Throughput"
      WindowsStorageCapacity:
        default: "Windows Storage Capacity (GB)"
      WindowsThroughputCapacity:
        default: "Windows Throughput Capacity"
      OntapStorageCapacity:
        default: "ONTAP Storage Capacity (GB)"
      OntapThroughputCapacity:
        default: "ONTAP Throughput Capacity"
      S3BucketName:
        default: "S3 Bucket Name"
      NfsVolumeSize:
        default: "NFS Volume Size (MB)"
      SmbVolumeSize:
        default: "SMB Volume Size (MB)"
      FsxAdminPassword:
        default: "FSx Admin Password"
      SvmAdminPassword:
        default: "SVM Admin Password"
      EnableEncryption:
        default: "Enable Encryption"
      EnableCloudWatchAlarms:
        default: "Enable CloudWatch Alarms"
      AlarmNotificationEmail:
        default: "Alarm Notification Email"
      EnableAutomatedBackups:
        default: "Enable Automated Backups"
      BackupRetentionDays:
        default: "Backup Retention Days"
      ResourcePrefix:
        default: "Resource Prefix"

Parameters:
  # Network Configuration
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID where FSx file systems will be deployed
    
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet IDs for FSx deployment (minimum 2 for ONTAP Multi-AZ)
    
  AllowedCidrBlock:
    Type: String
    Default: '10.0.0.0/8'
    Description: CIDR block allowed to access FSx file systems
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
    ConstraintDescription: Must be a valid CIDR notation (e.g., 10.0.0.0/8)

  # FSx Configuration
  LustreStorageCapacity:
    Type: Number
    Default: 1200
    Description: Storage capacity for Lustre file system in GB (minimum 1200 for SCRATCH_2)
    MinValue: 1200
    ConstraintDescription: Must be at least 1200 GB for SCRATCH_2 deployment type
    
  LustrePerUnitStorageThroughput:
    Type: Number
    Default: 250
    Description: Throughput per unit of storage for Lustre (50, 100, 200, 250 MB/s/TiB)
    AllowedValues: [50, 100, 200, 250]
    ConstraintDescription: Must be 50, 100, 200, or 250 MB/s/TiB
    
  WindowsStorageCapacity:
    Type: Number
    Default: 32
    Description: Storage capacity for Windows file system in GB (minimum 32)
    MinValue: 32
    ConstraintDescription: Must be at least 32 GB
    
  WindowsThroughputCapacity:
    Type: Number
    Default: 16
    Description: Throughput capacity for Windows file system in MB/s (8, 16, 32, 64, 128, 256, 512, 1024, 2048)
    AllowedValues: [8, 16, 32, 64, 128, 256, 512, 1024, 2048]
    ConstraintDescription: Must be 8, 16, 32, 64, 128, 256, 512, 1024, or 2048 MB/s
    
  OntapStorageCapacity:
    Type: Number
    Default: 1024
    Description: Storage capacity for ONTAP file system in GB (minimum 1024)
    MinValue: 1024
    ConstraintDescription: Must be at least 1024 GB
    
  OntapThroughputCapacity:
    Type: Number
    Default: 256
    Description: Throughput capacity for ONTAP file system in MB/s (128, 256, 512, 1024, 2048)
    AllowedValues: [128, 256, 512, 1024, 2048]
    ConstraintDescription: Must be 128, 256, 512, 1024, or 2048 MB/s

  # Storage Configuration
  S3BucketName:
    Type: String
    Description: S3 bucket name for Lustre data repository (leave empty to create new bucket)
    Default: ''
    AllowedPattern: '^$|^[a-z0-9][a-z0-9-]*[a-z0-9]$'
    ConstraintDescription: Must be empty or a valid S3 bucket name (lowercase, hyphens allowed)
    
  NfsVolumeSize:
    Type: Number
    Default: 102400
    Description: Size of NFS volume in MB (minimum 20480)
    MinValue: 20480
    ConstraintDescription: Must be at least 20480 MB (20 GB)
    
  SmbVolumeSize:
    Type: Number
    Default: 51200
    Description: Size of SMB volume in MB (minimum 20480)
    MinValue: 20480
    ConstraintDescription: Must be at least 20480 MB (20 GB)

  # Security Configuration
  FsxAdminPassword:
    Type: String
    NoEcho: true
    Description: Administrator password for FSx Windows and ONTAP file systems
    MinLength: 8
    MaxLength: 50
    AllowedPattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,50}$'
    ConstraintDescription: Must be 8-50 characters with uppercase, lowercase, number, and special character
    
  SvmAdminPassword:
    Type: String
    NoEcho: true
    Description: Administrator password for Storage Virtual Machine
    MinLength: 8
    MaxLength: 50
    AllowedPattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,50}$'
    ConstraintDescription: Must be 8-50 characters with uppercase, lowercase, number, and special character
    
  EnableEncryption:
    Type: String
    Default: 'true'
    Description: Enable encryption at rest for file systems
    AllowedValues: ['true', 'false']

  # Monitoring Configuration
  EnableCloudWatchAlarms:
    Type: String
    Default: 'true'
    Description: Enable CloudWatch alarms for monitoring
    AllowedValues: ['true', 'false']
    
  AlarmNotificationEmail:
    Type: String
    Description: Email address for alarm notifications (leave empty to skip SNS setup)
    Default: ''
    AllowedPattern: '^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    ConstraintDescription: Must be empty or a valid email address

  # Backup Configuration
  EnableAutomatedBackups:
    Type: String
    Default: 'true'
    Description: Enable automated backups for file systems
    AllowedValues: ['true', 'false']
    
  BackupRetentionDays:
    Type: Number
    Default: 7
    Description: Number of days to retain automated backups (1-90)
    MinValue: 1
    MaxValue: 90
    ConstraintDescription: Must be between 1 and 90 days

  # Resource Naming
  ResourcePrefix:
    Type: String
    Default: 'fsx-hpc'
    Description: Prefix for resource names
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9-]*$'
    MaxLength: 20
    ConstraintDescription: Must start with letter, contain only alphanumeric characters and hyphens, max 20 characters

Conditions:
  CreateS3Bucket: !Equals [!Ref S3BucketName, '']
  HasNotificationEmail: !Not [!Equals [!Ref AlarmNotificationEmail, '']]
  EnableAlarmsCondition: !Equals [!Ref EnableCloudWatchAlarms, 'true']
  EnableBackupsCondition: !Equals [!Ref EnableAutomatedBackups, 'true']
  EnableEncryptionCondition: !Equals [!Ref EnableEncryption, 'true']
  CreateNotificationTopic: !And 
    - !Condition EnableAlarmsCondition
    - !Condition HasNotificationEmail

Resources:
  # KMS Key for Encryption
  FsxKmsKey:
    Type: AWS::KMS::Key
    Condition: EnableEncryptionCondition
    Properties:
      Description: !Sub 'KMS key for ${ResourcePrefix} FSx file systems encryption'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow FSx Service
            Effect: Allow
            Principal:
              Service: fsx.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
              - kms:DescribeKey
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-kms-key'
        - Key: Purpose
          Value: 'FSx Encryption'

  FsxKmsKeyAlias:
    Type: AWS::KMS::Alias
    Condition: EnableEncryptionCondition
    Properties:
      AliasName: !Sub 'alias/${ResourcePrefix}-fsx-key'
      TargetKeyId: !Ref FsxKmsKey

  # S3 Bucket for Lustre Data Repository
  LustreDataBucket:
    Type: AWS::S3::Bucket
    Condition: CreateS3Bucket
    Properties:
      BucketName: !Sub '${ResourcePrefix}-lustre-data-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      NotificationConfiguration:
        CloudWatchConfigurations:
          - Event: 's3:ObjectCreated:*'
            CloudWatchConfiguration:
              LogGroupName: !Sub '/aws/s3/${ResourcePrefix}-lustre-data'
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-lustre-data'
        - Key: Purpose
          Value: 'FSx Lustre Data Repository'

  # Security Group for FSx File Systems
  FsxSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ResourcePrefix}-fsx-sg'
      GroupDescription: Security group for FSx file systems
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        # Lustre traffic
        - IpProtocol: tcp
          FromPort: 988
          ToPort: 988
          CidrIp: !Ref AllowedCidrBlock
          Description: 'FSx Lustre traffic'
        # SMB traffic for Windows File Server
        - IpProtocol: tcp
          FromPort: 445
          ToPort: 445
          CidrIp: !Ref AllowedCidrBlock
          Description: 'SMB traffic for Windows File Server'
        # NFS traffic for ONTAP
        - IpProtocol: tcp
          FromPort: 111
          ToPort: 111
          CidrIp: !Ref AllowedCidrBlock
          Description: 'NFS traffic for ONTAP'
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          CidrIp: !Ref AllowedCidrBlock
          Description: 'NFS traffic for ONTAP'
        # Additional ONTAP protocols
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref AllowedCidrBlock
          Description: 'ONTAP HTTP management'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AllowedCidrBlock
          Description: 'ONTAP HTTPS management'
        - IpProtocol: tcp
          FromPort: 635
          ToPort: 635
          CidrIp: !Ref AllowedCidrBlock
          Description: 'NFS mountd'
        - IpProtocol: udp
          FromPort: 111
          ToPort: 111
          CidrIp: !Ref AllowedCidrBlock
          Description: 'NFS portmapper UDP'
        - IpProtocol: udp
          FromPort: 635
          ToPort: 635
          CidrIp: !Ref AllowedCidrBlock
          Description: 'NFS mountd UDP'
        - IpProtocol: udp
          FromPort: 2049
          ToPort: 2049
          CidrIp: !Ref AllowedCidrBlock
          Description: 'NFS UDP'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: '0.0.0.0/0'
          Description: 'All outbound traffic'
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-fsx-sg'
        - Key: Purpose
          Value: 'FSx File Systems Security'

  # IAM Role for FSx Service
  FsxServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ResourcePrefix}-fsx-service-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: fsx.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      Policies:
        - PolicyName: FsxS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: 
                  - !Sub 
                    - '${BucketArn}/*'
                    - BucketArn: !If 
                      - CreateS3Bucket
                      - !GetAtt LustreDataBucket.Arn
                      - !Sub 'arn:aws:s3:::${S3BucketName}'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource: !If 
                  - CreateS3Bucket
                  - !GetAtt LustreDataBucket.Arn
                  - !Sub 'arn:aws:s3:::${S3BucketName}'
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-fsx-service-role'
        - Key: Purpose
          Value: 'FSx Service Access'

  # FSx for Lustre File System
  LustreFileSystem:
    Type: AWS::FSx::FileSystem
    Properties:
      FileSystemType: LUSTRE
      StorageCapacity: !Ref LustreStorageCapacity
      SubnetIds:
        - !Select [0, !Ref SubnetIds]
      SecurityGroupIds:
        - !Ref FsxSecurityGroup
      KmsKeyId: !If 
        - EnableEncryptionCondition
        - !Ref FsxKmsKey
        - !Ref 'AWS::NoValue'
      LustreConfiguration:
        DeploymentType: SCRATCH_2
        PerUnitStorageThroughput: !Ref LustrePerUnitStorageThroughput
        DataRepositoryConfiguration:
          Bucket: !If 
            - CreateS3Bucket
            - !Ref LustreDataBucket
            - !Ref S3BucketName
          ImportPath: !Sub 
            - 's3://${Bucket}/input/'
            - Bucket: !If 
              - CreateS3Bucket
              - !Ref LustreDataBucket
              - !Ref S3BucketName
          ExportPath: !Sub 
            - 's3://${Bucket}/output/'
            - Bucket: !If 
              - CreateS3Bucket
              - !Ref LustreDataBucket
              - !Ref S3BucketName
          AutoImportPolicy: NEW_CHANGED_DELETED
        DataCompressionType: LZ4
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-lustre'
        - Key: Purpose
          Value: 'HPC Workloads'
        - Key: FileSystemType
          Value: 'Lustre'

  # FSx for Windows File Server
  WindowsFileSystem:
    Type: AWS::FSx::FileSystem
    Properties:
      FileSystemType: WINDOWS
      StorageCapacity: !Ref WindowsStorageCapacity
      SubnetIds:
        - !Select [0, !Ref SubnetIds]
      SecurityGroupIds:
        - !Ref FsxSecurityGroup
      KmsKeyId: !If 
        - EnableEncryptionCondition
        - !Ref FsxKmsKey
        - !Ref 'AWS::NoValue'
      WindowsConfiguration:
        ThroughputCapacity: !Ref WindowsThroughputCapacity
        DeploymentType: SINGLE_AZ_2
        PreferredSubnetId: !Select [0, !Ref SubnetIds]
        # Note: Self-managed AD configuration would go here in production
        # SelfManagedActiveDirectoryConfiguration:
        #   DomainName: example.com
        #   OrganizationalUnitDistinguishedName: OU=FSx,DC=example,DC=com
        #   FileSystemAdministratorsGroup: Domain Admins
        #   UserName: admin
        #   Password: !Ref FsxAdminPassword
        #   DnsIps:
        #     - 10.0.0.100
        #     - 10.0.0.101
        AutomaticBackupRetentionDays: !If 
          - EnableBackupsCondition
          - !Ref BackupRetentionDays
          - 0
        DailyAutomaticBackupStartTime: '01:00'
        WeeklyMaintenanceStartTime: '2:02:00'
        CopyTagsToBackups: true
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-windows'
        - Key: Purpose
          Value: 'Windows Applications'
        - Key: FileSystemType
          Value: 'Windows'

  # FSx for NetApp ONTAP File System
  OntapFileSystem:
    Type: AWS::FSx::FileSystem
    Properties:
      FileSystemType: ONTAP
      StorageCapacity: !Ref OntapStorageCapacity
      SubnetIds: !Ref SubnetIds
      SecurityGroupIds:
        - !Ref FsxSecurityGroup
      KmsKeyId: !If 
        - EnableEncryptionCondition
        - !Ref FsxKmsKey
        - !Ref 'AWS::NoValue'
      OntapConfiguration:
        DeploymentType: MULTI_AZ_1
        ThroughputCapacity: !Ref OntapThroughputCapacity
        PreferredSubnetId: !Select [0, !Ref SubnetIds]
        RouteTableIds: []  # Would be populated with VPC route table IDs in production
        FsxAdminPassword: !Ref FsxAdminPassword
        AutomaticBackupRetentionDays: !If 
          - EnableBackupsCondition
          - !Ref BackupRetentionDays
          - 0
        DailyAutomaticBackupStartTime: '02:00'
        WeeklyMaintenanceStartTime: '3:03:00'
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-ontap'
        - Key: Purpose
          Value: 'Multi-Protocol Access'
        - Key: FileSystemType
          Value: 'ONTAP'

  # Storage Virtual Machine for ONTAP
  OntapStorageVirtualMachine:
    Type: AWS::FSx::StorageVirtualMachine
    Properties:
      FileSystemId: !Ref OntapFileSystem
      Name: 'demo-svm'
      SvmAdminPassword: !Ref SvmAdminPassword
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-svm'
        - Key: Purpose
          Value: 'Multi-Protocol SVM'

  # NFS Volume for ONTAP
  NfsVolume:
    Type: AWS::FSx::Volume
    Properties:
      VolumeType: ONTAP
      Name: 'nfs-volume'
      OntapConfiguration:
        StorageVirtualMachineId: !Ref OntapStorageVirtualMachine
        JunctionPath: '/nfs'
        SecurityStyle: UNIX
        SizeInMegabytes: !Ref NfsVolumeSize
        StorageEfficiencyEnabled: true
        TieringPolicy:
          CoolingPeriod: 31
          Name: SNAPSHOT_ONLY
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-nfs-volume'
        - Key: Protocol
          Value: 'NFS'

  # SMB Volume for ONTAP
  SmbVolume:
    Type: AWS::FSx::Volume
    Properties:
      VolumeType: ONTAP
      Name: 'smb-volume'
      OntapConfiguration:
        StorageVirtualMachineId: !Ref OntapStorageVirtualMachine
        JunctionPath: '/smb'
        SecurityStyle: NTFS
        SizeInMegabytes: !Ref SmbVolumeSize
        StorageEfficiencyEnabled: true
        TieringPolicy:
          CoolingPeriod: 31
          Name: SNAPSHOT_ONLY
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-smb-volume'
        - Key: Protocol
          Value: 'SMB'

  # SNS Topic for Alarm Notifications
  AlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Condition: CreateNotificationTopic
    Properties:
      TopicName: !Sub '${ResourcePrefix}-fsx-alarms'
      DisplayName: 'FSx File System Alarms'
      KmsMasterKeyId: 'alias/aws/sns'

  AlarmNotificationSubscription:
    Type: AWS::SNS::Subscription
    Condition: CreateNotificationTopic
    Properties:
      TopicArn: !Ref AlarmNotificationTopic
      Protocol: email
      Endpoint: !Ref AlarmNotificationEmail

  # CloudWatch Alarms
  LustreThroughputAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableAlarmsCondition
    Properties:
      AlarmName: !Sub '${ResourcePrefix}-lustre-throughput'
      AlarmDescription: 'Monitor Lustre throughput utilization'
      MetricName: ThroughputUtilization
      Namespace: AWS/FSx
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FileSystemId
          Value: !Ref LustreFileSystem
      AlarmActions: !If 
        - CreateNotificationTopic
        - [!Ref AlarmNotificationTopic]
        - []
      TreatMissingData: notBreaching

  WindowsCpuAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableAlarmsCondition
    Properties:
      AlarmName: !Sub '${ResourcePrefix}-windows-cpu'
      AlarmDescription: 'Monitor Windows file system CPU utilization'
      MetricName: CPUUtilization
      Namespace: AWS/FSx
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 85
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FileSystemId
          Value: !Ref WindowsFileSystem
      AlarmActions: !If 
        - CreateNotificationTopic
        - [!Ref AlarmNotificationTopic]
        - []
      TreatMissingData: notBreaching

  OntapStorageAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableAlarmsCondition
    Properties:
      AlarmName: !Sub '${ResourcePrefix}-ontap-storage'
      AlarmDescription: 'Monitor ONTAP storage utilization'
      MetricName: StorageUtilization
      Namespace: AWS/FSx
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 90
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FileSystemId
          Value: !Ref OntapFileSystem
      AlarmActions: !If 
        - CreateNotificationTopic
        - [!Ref AlarmNotificationTopic]
        - []
      TreatMissingData: notBreaching

  # CloudWatch Log Groups for Enhanced Monitoring
  FsxLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableAlarmsCondition
    Properties:
      LogGroupName: !Sub '/aws/fsx/${ResourcePrefix}'
      RetentionInDays: 30

  # CloudWatch Dashboard for Comprehensive FSx Monitoring
  FsxMonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: EnableAlarmsCondition
    Properties:
      DashboardName: !Sub '${ResourcePrefix}-fsx-monitoring-dashboard'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/FSx", "ThroughputUtilization", "FileSystemId", "${LustreFileSystem}" ],
                  [ ".", "StorageUtilization", ".", "." ],
                  [ ".", "DataReadBytes", ".", "." ],
                  [ ".", "DataWriteBytes", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Lustre File System Performance",
                "period": 300,
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/FSx", "CPUUtilization", "FileSystemId", "${WindowsFileSystem}" ],
                  [ ".", "NetworkThroughputUtilization", ".", "." ],
                  [ ".", "DiskThroughputUtilization", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Windows File System Performance",
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/FSx", "StorageUtilization", "FileSystemId", "${OntapFileSystem}" ],
                  [ ".", "ThroughputUtilization", ".", "." ],
                  [ ".", "StorageEfficiencyRatio", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ONTAP File System Performance & Efficiency",
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/FSx", "ClientConnections", "FileSystemId", "${LustreFileSystem}", { "label": "Lustre Connections" } ],
                  [ ".", ".", ".", "${WindowsFileSystem}", { "label": "Windows Connections" } ],
                  [ ".", ".", ".", "${OntapFileSystem}", { "label": "ONTAP Connections" } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Client Connections",
                "period": 300
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 12,
              "width": 24,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/fsx/${ResourcePrefix}'\n| fields @timestamp, @message\n| filter @message like /ERROR/\n| sort @timestamp desc\n| limit 100",
                "region": "${AWS::Region}",
                "title": "Recent FSx Errors",
                "view": "table"
              }
            }
          ]
        }

Outputs:
  # File System Information
  LustreFileSystemId:
    Description: FSx for Lustre file system ID
    Value: !Ref LustreFileSystem
    Export:
      Name: !Sub '${AWS::StackName}-LustreFileSystemId'

  LustreFileSystemDnsName:
    Description: FSx for Lustre DNS name
    Value: !GetAtt LustreFileSystem.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-LustreFileSystemDnsName'

  LustreMountName:
    Description: FSx for Lustre mount name
    Value: !GetAtt LustreFileSystem.LustreMountName
    Export:
      Name: !Sub '${AWS::StackName}-LustreMountName'

  LustreMountCommand:
    Description: Command to mount Lustre file system
    Value: !Sub 
      - 'sudo mount -t lustre ${DNSName}@tcp:/${MountName} /mnt/fsx'
      - DNSName: !GetAtt LustreFileSystem.DNSName
        MountName: !GetAtt LustreFileSystem.LustreMountName

  WindowsFileSystemId:
    Description: FSx for Windows file system ID
    Value: !Ref WindowsFileSystem
    Export:
      Name: !Sub '${AWS::StackName}-WindowsFileSystemId'

  WindowsFileSystemDnsName:
    Description: FSx for Windows DNS name
    Value: !GetAtt WindowsFileSystem.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-WindowsFileSystemDnsName'

  WindowsSmbSharePath:
    Description: Windows SMB share path
    Value: !Sub '\\${WindowsFileSystem.DNSName}\share'

  OntapFileSystemId:
    Description: FSx for NetApp ONTAP file system ID
    Value: !Ref OntapFileSystem
    Export:
      Name: !Sub '${AWS::StackName}-OntapFileSystemId'

  OntapManagementDnsName:
    Description: ONTAP management DNS name
    Value: !GetAtt OntapFileSystem.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-OntapManagementDnsName'

  StorageVirtualMachineId:
    Description: Storage Virtual Machine ID
    Value: !Ref OntapStorageVirtualMachine
    Export:
      Name: !Sub '${AWS::StackName}-StorageVirtualMachineId'

  NfsVolumeId:
    Description: NFS volume ID
    Value: !Ref NfsVolume
    Export:
      Name: !Sub '${AWS::StackName}-NfsVolumeId'

  SmbVolumeId:
    Description: SMB volume ID
    Value: !Ref SmbVolume
    Export:
      Name: !Sub '${AWS::StackName}-SmbVolumeId'

  # Network Information
  SecurityGroupId:
    Description: Security group ID for FSx file systems
    Value: !Ref FsxSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroupId'

  # Storage Information
  S3BucketName:
    Description: S3 bucket name for Lustre data repository
    Value: !If 
      - CreateS3Bucket
      - !Ref LustreDataBucket
      - !Ref S3BucketName
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketName'

  # Encryption Information
  KmsKeyId:
    Condition: EnableEncryptionCondition
    Description: KMS key ID for FSx encryption
    Value: !Ref FsxKmsKey
    Export:
      Name: !Sub '${AWS::StackName}-KmsKeyId'

  KmsKeyAlias:
    Condition: EnableEncryptionCondition
    Description: KMS key alias for FSx encryption
    Value: !Ref FsxKmsKeyAlias
    Export:
      Name: !Sub '${AWS::StackName}-KmsKeyAlias'

  # Monitoring Information
  AlarmTopicArn:
    Condition: CreateNotificationTopic
    Description: SNS topic ARN for alarm notifications
    Value: !Ref AlarmNotificationTopic
    Export:
      Name: !Sub '${AWS::StackName}-AlarmTopicArn'

  CloudWatchDashboardUrl:
    Condition: EnableAlarmsCondition
    Description: URL to CloudWatch dashboard for FSx monitoring
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${FsxMonitoringDashboard}'

  CloudWatchDashboardName:
    Condition: EnableAlarmsCondition
    Description: CloudWatch dashboard name for FSx monitoring
    Value: !Ref FsxMonitoringDashboard
    Export:
      Name: !Sub '${AWS::StackName}-CloudWatchDashboardName'

  # Access Commands
  NfsMountCommand:
    Description: Command to mount NFS volume
    Value: !Sub 
      - 'sudo mount -t nfs ${SvmNfsEndpoint}:/nfs /mnt/nfs'
      - SvmNfsEndpoint: !GetAtt OntapStorageVirtualMachine.Endpoints.Nfs.DNSName

  # Cost Estimation
  EstimatedMonthlyCost:
    Description: Estimated monthly cost for all resources (USD, approximate)
    Value: !Sub 
      - 'Lustre: $${LustreCost}, Windows: $${WindowsCost}, ONTAP: $${OntapCost}, Total: ~$${TotalCost}/month'
      - LustreCost: !Sub 
        - '${Cost}'
        - Cost: !Ref LustreStorageCapacity  # Simplified calculation
        WindowsCost: !Sub 
        - '${Cost}'
        - Cost: !Ref WindowsStorageCapacity  # Simplified calculation
        OntapCost: !Sub 
        - '${Cost}'
        - Cost: !Ref OntapStorageCapacity  # Simplified calculation
        TotalCost: !Sub 
        - '${Cost}'
        - Cost: 500  # Approximate total

  # Quick Start Guide
  QuickStartCommands:
    Description: Quick start commands for accessing file systems
    Value: !Sub |
      # === LUSTRE FILE SYSTEM SETUP ===
      # Install Lustre client (Amazon Linux 2)
      sudo amazon-linux-extras install -y lustre2.10
      
      # Mount Lustre file system
      sudo mkdir -p /mnt/fsx
      sudo mount -t lustre ${LustreFileSystem.DNSName}@tcp:/${LustreFileSystem.LustreMountName} /mnt/fsx
      
      # Test Lustre performance
      cd /mnt/fsx
      dd if=/dev/zero of=test_write.dat bs=1M count=1000 oflag=direct
      dd if=test_write.dat of=/dev/null bs=1M iflag=direct
      rm test_write.dat
      
      # === NFS VOLUME SETUP ===
      # Mount NFS volume (from Linux client)
      sudo mkdir -p /mnt/nfs
      sudo mount -t nfs ${OntapStorageVirtualMachine.Endpoints.Nfs.DNSName}:/nfs /mnt/nfs
      
      # === WINDOWS SMB SETUP ===
      # Access Windows SMB share (from Windows client)
      # net use Z: \\${WindowsFileSystem.DNSName}\share
      
      # === PERFORMANCE MONITORING ===
      # Monitor file system metrics
      aws cloudwatch get-metric-statistics --namespace AWS/FSx --metric-name ThroughputUtilization --dimensions Name=FileSystemId,Value=${LustreFileSystem} --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) --end-time $(date -u +%Y-%m-%dT%H:%M:%S) --period 300 --statistics Average

  # Performance Optimization Guide
  PerformanceOptimizationTips:
    Description: Performance optimization guidelines for FSx file systems
    Value: |
      === LUSTRE OPTIMIZATION ===
      1. Use multiple clients for parallel I/O to maximize throughput
      2. Use direct I/O (O_DIRECT) for large sequential operations
      3. Set stripe count: lfs setstripe -c -1 /mnt/fsx/directory
      4. Monitor data repository sync: lfs df -h
      
      === WINDOWS OPTIMIZATION ===
      1. Enable SMB Multichannel for high-bandwidth clients
      2. Use large I/O sizes (>64KB) for better throughput
      3. Configure client-side caching appropriately
      
      === ONTAP OPTIMIZATION ===
      1. Enable compression and deduplication for space efficiency
      2. Use appropriate volume tiering policies
      3. Monitor storage efficiency ratios
      4. Use FlexClone for rapid data copies

  # Security Best Practices
  SecurityGuidelines:
    Description: Security best practices for FSx deployments
    Value: |
      === NETWORK SECURITY ===
      1. Use VPC endpoints for S3 access from Lustre
      2. Implement least-privilege security group rules
      3. Enable VPC Flow Logs for network monitoring
      
      === ACCESS CONTROL ===
      1. Use IAM roles instead of access keys
      2. Implement regular credential rotation
      3. Enable CloudTrail for API logging
      
      === ENCRYPTION ===
      1. Enable encryption at rest with customer-managed KMS keys
      2. Use SSL/TLS for all client connections
      3. Regularly rotate encryption keys
      
      === MONITORING ===
      1. Set up CloudWatch alarms for critical metrics
      2. Enable detailed monitoring for all file systems
      3. Review access logs regularly

  # Cleanup Instructions
  CleanupInstructions:
    Description: Comprehensive cleanup instructions to avoid ongoing charges
    Value: !Sub |
      === IMPORTANT: CLEANUP TO AVOID CHARGES ===
      
      1. Delete CloudFormation Stack:
         aws cloudformation delete-stack --stack-name ${AWS::StackName}
      
      2. Verify File System Deletion:
         aws fsx describe-file-systems --query 'FileSystems[?contains(Tags[?Key==`Name`].Value, `${ResourcePrefix}`)]'
      
      3. Check for Backup Snapshots (may incur charges):
         aws fsx describe-backups --query 'Backups[?contains(Tags[?Key==`Name`].Value, `${ResourcePrefix}`)]'
      
      4. Empty S3 Bucket (if created by stack):
         aws s3 rm s3://${ResourcePrefix}-lustre-data-${AWS::AccountId}-${AWS::Region} --recursive
      
      5. Verify All Resources Deleted:
         - Check FSx console for any remaining file systems
         - Check CloudWatch for any remaining alarms
         - Check IAM for any remaining roles
         - Check KMS for any remaining keys
      
      6. Review Final Charges:
         - Check AWS Billing console for FSx charges
         - Verify no data transfer charges from S3 sync
         - Confirm backup storage charges are stopped
      
      === ESTIMATED CLEANUP TIME ===
      - File systems: 10-30 minutes to fully delete
      - S3 bucket: Immediate after emptying
      - KMS keys: 7-30 day pending deletion period
      - Total time to zero charges: 30 minutes to 1 hour

  # Deployment Validation
  DeploymentValidation:
    Description: Commands to validate successful deployment
    Value: !Sub |
      === VALIDATE DEPLOYMENT ===
      
      # Check file system status
      aws fsx describe-file-systems --file-system-ids ${LustreFileSystem} ${WindowsFileSystem} ${OntapFileSystem}
      
      # Verify S3 integration (Lustre)
      aws s3 ls s3://${ResourcePrefix}-lustre-data-${AWS::AccountId}-${AWS::Region}/
      
      # Check CloudWatch alarms
      aws cloudwatch describe-alarms --alarm-names ${ResourcePrefix}-lustre-throughput ${ResourcePrefix}-windows-cpu ${ResourcePrefix}-ontap-storage
      
      # Verify security group rules
      aws ec2 describe-security-groups --group-ids ${FsxSecurityGroup}
      
      # Test connectivity (run from EC2 instance in same VPC)
      # telnet ${LustreFileSystem.DNSName} 988
      # telnet ${WindowsFileSystem.DNSName} 445
      # telnet ${OntapStorageVirtualMachine.Endpoints.Nfs.DNSName} 2049