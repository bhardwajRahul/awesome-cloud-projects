{
  "widgets": [
    {
      "type": "metric",
      "x": 0,
      "y": 0,
      "width": 12,
      "height": 6,
      "properties": {
        "metrics": [
          [ "AWS/MediaConnect", "SourcePacketLossPercent", "FlowARN", "${flow_arn}", { "stat": "Maximum", "color": "#d62728" } ],
          [ ".", "SourceJitter", ".", ".", { "stat": "Average", "yAxis": "right", "color": "#ff7f0e" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "${region}",
        "title": "Stream Health Metrics",
        "period": 300,
        "yAxis": {
          "left": {
            "min": 0,
            "label": "Packet Loss (%)"
          },
          "right": {
            "min": 0,
            "label": "Jitter (ms)"
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "Packet Loss Threshold (0.1%)",
              "value": 0.1,
              "color": "#d62728"
            },
            {
              "label": "Jitter Threshold (50ms)",
              "value": 50,
              "yAxis": "right",
              "color": "#ff7f0e"
            }
          ]
        }
      }
    },
    {
      "type": "metric",
      "x": 12,
      "y": 0,
      "width": 12,
      "height": 6,
      "properties": {
        "metrics": [
          [ "AWS/MediaConnect", "SourceBitrate", "FlowARN", "${flow_arn}", { "stat": "Average", "color": "#2ca02c" } ],
          [ ".", "SourceUptime", ".", ".", { "stat": "Maximum", "yAxis": "right", "color": "#1f77b4" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "${region}",
        "title": "Stream Performance Metrics",
        "period": 300,
        "yAxis": {
          "left": {
            "min": 0,
            "label": "Bitrate (bps)"
          },
          "right": {
            "min": 0,
            "max": 100,
            "label": "Uptime (%)"
          }
        }
      }
    },
    {
      "type": "metric",
      "x": 0,
      "y": 6,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [ "AWS/MediaConnect", "SourceConnected", "FlowARN", "${flow_arn}", { "stat": "Maximum" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "${region}",
        "title": "Source Connection Status",
        "period": 300,
        "yAxis": {
          "left": {
            "min": 0,
            "max": 1,
            "label": "Connected (1=Yes, 0=No)"
          }
        }
      }
    },
    {
      "type": "metric",
      "x": 8,
      "y": 6,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [ "AWS/MediaConnect", "OutputConnected", "FlowARN", "${flow_arn}", "OutputName", "PrimaryOutput", { "stat": "Maximum", "color": "#2ca02c" } ],
          [ ".", ".", ".", ".", ".", "BackupOutput", { "stat": "Maximum", "color": "#ff7f0e" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "${region}",
        "title": "Output Connection Status",
        "period": 300,
        "yAxis": {
          "left": {
            "min": 0,
            "max": 1,
            "label": "Connected (1=Yes, 0=No)"
          }
        }
      }
    },
    {
      "type": "metric",
      "x": 16,
      "y": 6,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [ "AWS/MediaConnect", "SourceDroppedPackets", "FlowARN", "${flow_arn}", { "stat": "Sum", "color": "#d62728" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "${region}",
        "title": "Dropped Packets",
        "period": 300,
        "yAxis": {
          "left": {
            "min": 0,
            "label": "Packets"
          }
        }
      }
    },
    {
      "type": "log",
      "x": 0,
      "y": 12,
      "width": 12,
      "height": 6,
      "properties": {
        "query": "SOURCE '/aws/stepfunctions/media-workflow'\n| fields @timestamp, @message\n| filter @message like /CRITICAL\\|HIGH\\|ERROR/\n| sort @timestamp desc\n| limit 20",
        "region": "${region}",
        "title": "Recent Step Functions Executions (Errors/Alerts)",
        "view": "table"
      }
    },
    {
      "type": "log",
      "x": 12,
      "y": 12,
      "width": 12,
      "height": 6,
      "properties": {
        "query": "SOURCE '/aws/lambda/media-workflow-stream-monitor'\n| fields @timestamp, @message\n| filter @message like /ISSUES DETECTED\\|ERROR\\|CRITICAL/\n| sort @timestamp desc\n| limit 20",
        "region": "${region}",
        "title": "Stream Monitor Lambda Logs (Issues Only)",
        "view": "table"
      }
    },
    {
      "type": "text",
      "x": 0,
      "y": 18,
      "width": 24,
      "height": 3,
      "properties": {
        "markdown": "## MediaConnect Flow Monitoring Dashboard\n\n**Flow ARN:** `${flow_arn}`\n\n**Key Metrics:**\n- **Packet Loss**: Should remain below 0.1% for optimal quality\n- **Jitter**: Should stay under 50ms for stable streaming  \n- **Bitrate**: Monitor for consistency and expected values\n- **Uptime**: Should maintain close to 100%\n- **Connection Status**: Both source and outputs should show as connected (value = 1)\n\n**Alert Thresholds:**\n- Packet Loss > 0.1% triggers HIGH severity alert\n- Jitter > 50ms triggers MEDIUM severity alert  \n- Flow status != ACTIVE triggers CRITICAL alert\n\n**Console Links:**\n- [MediaConnect Console](https://console.aws.amazon.com/mediaconnect/home?region=${region})\n- [Step Functions Console](https://console.aws.amazon.com/states/home?region=${region})\n- [CloudWatch Alarms](https://console.aws.amazon.com/cloudwatch/home?region=${region}#alarmsV2:)\n"
      }
    }
  ]
}