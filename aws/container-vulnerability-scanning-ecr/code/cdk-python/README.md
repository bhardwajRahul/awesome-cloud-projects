# Container Image Vulnerability Scanning with ECR and Inspector - CDK Python

This CDK Python application deploys a comprehensive container image vulnerability scanning solution using Amazon ECR enhanced scanning with Amazon Inspector integration. The solution provides automated vulnerability detection, continuous monitoring, and real-time alerting for containerized applications.

## Architecture Overview

The application creates the following AWS resources:

- **Amazon ECR Repository** with enhanced scanning enabled
- **Amazon Inspector** enhanced scanning configuration for continuous monitoring
- **Amazon SNS Topic** for vulnerability alert notifications
- **Amazon CloudWatch** alarms for critical vulnerability detection
- **Amazon EventBridge** rules for real-time event processing
- **AWS Lambda** custom resource for Inspector configuration
- **IAM Roles** with least privilege permissions

## Features

### Enhanced Security Scanning
- **Deep Vulnerability Detection**: Scans both OS packages and programming language libraries
- **Continuous Monitoring**: 30-day rescan duration for ongoing threat detection
- **Multi-Database Coverage**: Leverages CVE databases and vendor-specific advisories
- **Severity Classification**: CRITICAL, HIGH, MEDIUM, LOW vulnerability categorization

### Automated Alerting
- **Real-time Notifications**: EventBridge integration for immediate alerts
- **Email Notifications**: SNS email subscriptions for security teams
- **CloudWatch Integration**: Metrics and alarms for vulnerability tracking
- **Centralized Logging**: CloudWatch Logs for audit and compliance

### DevOps Integration
- **Scan on Push**: Automatic scanning when images are pushed to ECR
- **CI/CD Ready**: Designed for integration with deployment pipelines
- **Cost Optimized**: Lifecycle policies for image management
- **Compliance Ready**: Audit logging and reporting capabilities

## Prerequisites

Before deploying this CDK application, ensure you have:

1. **AWS CLI** configured with appropriate credentials
2. **AWS CDK** v2.167.1 or later installed
3. **Python** 3.8 or later
4. **Node.js** 18.x or later (for CDK CLI)
5. **Docker** (for building and testing container images)

### Required AWS Permissions

Your AWS credentials must have permissions for:
- ECR repository management
- Inspector service management
- SNS topic creation and management
- CloudWatch metrics and alarms
- EventBridge rules management
- IAM role creation
- Lambda function deployment

## Installation

1. **Clone or download** this CDK application code

2. **Install Python dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Install development dependencies** (optional):
   ```bash
   pip install -r requirements.txt[dev]
   ```

4. **Bootstrap your AWS environment** (if not already done):
   ```bash
   cdk bootstrap
   ```

## Configuration

### Environment Variables

Set the following environment variables for customization:

```bash
# AWS account and region (required for deployment)
export CDK_DEFAULT_ACCOUNT="123456789012"
export CDK_DEFAULT_REGION="us-east-1"

# Optional: Custom notification email
export NOTIFICATION_EMAIL="security-team@yourcompany.com"

# Optional: Custom repository name
export REPOSITORY_NAME="your-app-repository"
```

### CDK Context Parameters

You can also configure the application using CDK context in `cdk.json`:

```json
{
  "context": {
    "notification_email": "security-team@yourcompany.com",
    "repository_name": "your-app-repository"
  }
}
```

## Deployment

### Quick Deployment

Deploy the complete solution with default settings:

```bash
cdk deploy
```

### Custom Configuration Deployment

Deploy with custom parameters:

```bash
cdk deploy \
    --context notification_email="security@yourcompany.com" \
    --context repository_name="production-app"
```

### Preview Changes

Review what resources will be created:

```bash
cdk diff
```

### Deployment with Approval

Deploy with manual approval for security changes:

```bash
cdk deploy --require-approval any-change
```

## Usage

### Push Container Images

After deployment, push container images to the created ECR repository:

```bash
# Get repository URI from CDK outputs
REPOSITORY_URI=$(aws cloudformation describe-stacks \
    --stack-name ContainerVulnerabilityScanningStack \
    --query 'Stacks[0].Outputs[?OutputKey==`ECRRepositoryURI`].OutputValue' \
    --output text)

# Authenticate Docker with ECR
aws ecr get-login-password --region $CDK_DEFAULT_REGION | \
    docker login --username AWS --password-stdin $REPOSITORY_URI

# Build and push your image
docker build -t $REPOSITORY_URI:latest .
docker push $REPOSITORY_URI:latest
```

### Monitor Scan Results

View vulnerability scan findings:

```bash
# Get repository name from outputs
REPOSITORY_NAME=$(aws cloudformation describe-stacks \
    --stack-name ContainerVulnerabilityScanningStack \
    --query 'Stacks[0].Outputs[?OutputKey==`ECRRepositoryName`].OutputValue' \
    --output text)

# Check scan findings
aws ecr describe-image-scan-findings \
    --repository-name $REPOSITORY_NAME \
    --image-id imageTag=latest
```

### Email Subscription Confirmation

After deployment:

1. Check your email for an SNS subscription confirmation
2. Click the confirmation link to receive vulnerability alerts
3. Verify subscription in the AWS SNS console

## Testing

### Unit Tests

Run unit tests for the CDK application:

```bash
python -m pytest tests/ -v
```

### Integration Tests

Test the deployed infrastructure:

```bash
# Test ECR repository access
aws ecr describe-repositories --repository-names $REPOSITORY_NAME

# Test SNS topic
aws sns list-subscriptions-by-topic --topic-arn $SNS_TOPIC_ARN

# Test CloudWatch alarm
aws cloudwatch describe-alarms --alarm-names ECR-Critical-Vulnerabilities
```

### Code Quality

Run code quality checks:

```bash
# Format code
black app.py

# Lint code
flake8 app.py

# Type checking
mypy app.py
```

## Customization

### Notification Channels

Add additional notification targets to the EventBridge rule:

```python
# Add Slack webhook target
rule.add_target(
    targets.LambdaFunction(slack_webhook_function)
)

# Add SQS queue target for processing
rule.add_target(
    targets.SqsQueue(processing_queue)
)
```

### Custom Vulnerability Policies

Implement custom vulnerability assessment logic:

```python
# Create Lambda function for custom processing
custom_processor = aws_lambda.Function(
    self,
    "CustomVulnerabilityProcessor",
    runtime=aws_lambda.Runtime.PYTHON_3_9,
    handler="index.handler",
    code=aws_lambda.Code.from_asset("lambda/custom-processor")
)

# Add as EventBridge target
rule.add_target(
    targets.LambdaFunction(custom_processor)
)
```

### Multi-Repository Support

Extend the solution for multiple repositories:

```python
# Create multiple repositories with shared configuration
repositories = ["app1", "app2", "app3"]

for repo_name in repositories:
    repository = ecr.Repository(
        self,
        f"Repository{repo_name.title()}",
        repository_name=repo_name,
        image_scan_on_push=True
    )
```

## Monitoring and Troubleshooting

### CloudWatch Dashboards

Create custom dashboards for vulnerability metrics:

```bash
# View vulnerability trends
aws cloudwatch get-metric-statistics \
    --namespace "AWS/Inspector" \
    --metric-name "VulnerabilitiesFound" \
    --start-time "2024-01-01T00:00:00Z" \
    --end-time "2024-01-31T23:59:59Z" \
    --period 86400 \
    --statistics Sum
```

### Log Analysis

Monitor Inspector findings in CloudWatch Logs:

```bash
# View recent Inspector events
aws logs filter-log-events \
    --log-group-name "/aws/inspector/ecr-findings" \
    --start-time $(date -d "1 hour ago" +%s)000
```

### Common Issues

**Inspector Not Enabling**: Ensure your account has Inspector service-linked roles
```bash
aws iam create-service-linked-role --aws-service-name inspector2.amazonaws.com
```

**Scan Failures**: Check ECR repository permissions and image format compatibility

**Missing Alerts**: Verify SNS subscription confirmation and EventBridge rule configuration

## Security Considerations

### IAM Permissions

The application follows AWS security best practices:
- **Least Privilege**: Minimal required permissions for each service
- **Service-Linked Roles**: Uses AWS-managed policies where possible
- **Resource-Level Permissions**: Specific resource ARNs where applicable

### Data Protection

- **Encryption**: ECR images encrypted at rest with AES-256
- **Access Logging**: All API calls logged via CloudTrail
- **Network Security**: VPC endpoints supported for private communication

### Compliance

- **Audit Logging**: Complete audit trail in CloudWatch Logs
- **Retention Policies**: Configurable log retention periods
- **Compliance Reports**: Export scan findings for compliance reporting

## Cost Optimization

### Pricing Considerations

- **Amazon Inspector**: $0.09 per image scanned (first push)
- **ECR Storage**: $0.10 per GB-month for private repositories
- **CloudWatch**: Minimal costs for metrics and logs
- **SNS**: $0.50 per million notifications

### Cost Control Measures

1. **Lifecycle Policies**: Automatic cleanup of old images
2. **Selective Scanning**: Configure scan rules for specific repositories
3. **Rescan Optimization**: 30-day rescan period balances security and cost
4. **Log Retention**: 30-day retention for cost control

## Cleanup

Remove all resources created by this CDK application:

```bash
cdk destroy
```

**Warning**: This will permanently delete all resources including:
- ECR repositories and container images
- CloudWatch alarms and log groups
- SNS topics and subscriptions
- Inspector scanning configurations

## Support and Contributing

### Documentation

- [AWS CDK Python Reference](https://docs.aws.amazon.com/cdk/api/v2/python/)
- [Amazon ECR User Guide](https://docs.aws.amazon.com/AmazonECR/latest/userguide/)
- [Amazon Inspector User Guide](https://docs.aws.amazon.com/inspector/latest/user/)

### Best Practices

- Follow the [AWS Well-Architected Framework](https://aws.amazon.com/architecture/well-architected/)
- Implement [container security best practices](https://aws.amazon.com/container-security/)
- Use [AWS Security Hub](https://aws.amazon.com/security-hub/) for centralized findings

### Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Submit a pull request

## License

This code is licensed under the Apache License 2.0. See the LICENSE file for details.