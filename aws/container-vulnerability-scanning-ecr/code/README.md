# Infrastructure as Code for Container Image Vulnerability Scanning with ECR and Inspector

This directory contains Infrastructure as Code (IaC) implementations for the recipe "Container Vulnerability Scanning with ECR".

## Available Implementations

- **CloudFormation**: AWS native infrastructure as code (YAML)
- **CDK TypeScript**: AWS Cloud Development Kit (TypeScript)
- **CDK Python**: AWS Cloud Development Kit (Python)
- **Terraform**: Multi-cloud infrastructure as code
- **Scripts**: Bash deployment and cleanup scripts

## Prerequisites

- AWS CLI v2 installed and configured
- Docker installed for building and pushing container images
- Appropriate AWS permissions for:
  - Amazon ECR (create repositories, push images, configure scanning)
  - Amazon Inspector (enable scanning, view findings)
  - Amazon CloudWatch (create alarms, manage log groups)
  - Amazon EventBridge (create rules, manage targets)
  - Amazon SNS (create topics, manage subscriptions)
- Node.js 16+ (for CDK TypeScript)
- Python 3.8+ (for CDK Python)
- Terraform 1.0+ (for Terraform implementation)

## Quick Start

### Using CloudFormation
```bash
# Set required parameters
export EMAIL_ADDRESS="your-email@example.com"

# Deploy the stack
aws cloudformation create-stack \
    --stack-name container-vulnerability-scanning \
    --template-body file://cloudformation.yaml \
    --parameters ParameterKey=EmailAddress,ParameterValue=${EMAIL_ADDRESS} \
    --capabilities CAPABILITY_IAM

# Wait for stack creation to complete
aws cloudformation wait stack-create-complete \
    --stack-name container-vulnerability-scanning

# Get outputs
aws cloudformation describe-stacks \
    --stack-name container-vulnerability-scanning \
    --query 'Stacks[0].Outputs'
```

### Using CDK TypeScript
```bash
cd cdk-typescript/

# Install dependencies
npm install

# Set context parameters
export CDK_DEFAULT_REGION=$(aws configure get region)
export EMAIL_ADDRESS="your-email@example.com"

# Bootstrap CDK (if first time)
cdk bootstrap

# Deploy the stack
cdk deploy --parameters emailAddress=${EMAIL_ADDRESS}

# View outputs
cdk outputs
```

### Using CDK Python
```bash
cd cdk-python/

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Set environment variables
export CDK_DEFAULT_REGION=$(aws configure get region)
export EMAIL_ADDRESS="your-email@example.com"

# Bootstrap CDK (if first time)
cdk bootstrap

# Deploy the stack
cdk deploy --parameters emailAddress=${EMAIL_ADDRESS}

# View outputs
cdk outputs
```

### Using Terraform
```bash
cd terraform/

# Initialize Terraform
terraform init

# Create terraform.tfvars file
cat > terraform.tfvars << EOF
email_address = "your-email@example.com"
environment   = "demo"
EOF

# Review the deployment plan
terraform plan

# Apply the configuration
terraform apply

# View outputs
terraform output
```

### Using Bash Scripts
```bash
# Make scripts executable
chmod +x scripts/deploy.sh scripts/destroy.sh

# Set required environment variables
export EMAIL_ADDRESS="your-email@example.com"

# Deploy the infrastructure
./scripts/deploy.sh

# View deployment outputs
cat deployment-outputs.json
```

## Architecture Overview

This infrastructure deployment creates:

1. **Amazon ECR Repository** with enhanced scanning enabled
2. **Amazon Inspector** enhanced scanning configuration
3. **CloudWatch Alarms** for vulnerability monitoring
4. **EventBridge Rules** for real-time notifications
5. **SNS Topic** and email subscription for alerts
6. **IAM Roles and Policies** for secure service integration

The solution provides:
- Automatic vulnerability scanning on image push
- Continuous monitoring for newly discovered vulnerabilities
- Real-time alerting for critical security findings
- Integration with AWS native security services

## Post-Deployment Steps

1. **Confirm SNS Subscription**:
   ```bash
   # Check your email for subscription confirmation
   echo "Please confirm the SNS subscription in your email"
   ```

2. **Build and Push Sample Images**:
   ```bash
   # Get ECR repository URI from outputs
   ECR_REPOSITORY_URI=$(aws cloudformation describe-stacks \
       --stack-name container-vulnerability-scanning \
       --query 'Stacks[0].Outputs[?OutputKey==`ECRRepositoryURI`].OutputValue' \
       --output text)

   # Authenticate Docker with ECR
   aws ecr get-login-password --region $(aws configure get region) | \
       docker login --username AWS --password-stdin \
       $(echo $ECR_REPOSITORY_URI | cut -d'/' -f1)

   # Build and push a sample vulnerable image
   mkdir sample-app && cd sample-app
   cat > Dockerfile << 'EOF'
   FROM ubuntu:20.04
   RUN apt-get update && apt-get install -y curl wget apache2
   EXPOSE 80
   CMD ["apache2ctl", "-D", "FOREGROUND"]
   EOF

   docker build -t ${ECR_REPOSITORY_URI}:vulnerable-v1.0 .
   docker push ${ECR_REPOSITORY_URI}:vulnerable-v1.0
   ```

3. **Monitor Scan Results**:
   ```bash
   # Wait for scan completion (5-10 minutes)
   sleep 300

   # Check scan findings
   REPOSITORY_NAME=$(echo $ECR_REPOSITORY_URI | cut -d'/' -f2)
   aws ecr describe-image-scan-findings \
       --repository-name $REPOSITORY_NAME \
       --image-id imageTag=vulnerable-v1.0 \
       --query 'imageScanFindings.findingSeverityCounts'
   ```

## Monitoring and Alerting

### CloudWatch Dashboards
The deployment creates CloudWatch alarms that monitor:
- Critical vulnerability counts
- High severity vulnerability trends
- Scan completion rates

### EventBridge Integration
Real-time events are captured for:
- New vulnerability findings
- Scan completion notifications
- Inspector status changes

### SNS Notifications
Email alerts are sent for:
- Critical vulnerabilities detected
- High-priority security findings
- Scan failures or errors

## Customization

### Environment Variables
- `EMAIL_ADDRESS`: Email for vulnerability alerts
- `ENVIRONMENT`: Deployment environment tag
- `REPOSITORY_NAME`: Custom ECR repository name
- `RETENTION_DAYS`: CloudWatch log retention period

### Terraform Variables
Key variables in `terraform.tfvars`:
- `email_address`: Email for SNS notifications
- `environment`: Environment tag for resources
- `repository_name`: ECR repository name
- `scan_frequency`: Continuous or on-push scanning
- `retention_days`: Log group retention period

### CDK Context
Set context parameters for CDK deployments:
- `emailAddress`: Email for notifications
- `environment`: Deployment environment
- `repositoryName`: ECR repository name

## Security Considerations

### IAM Permissions
The infrastructure follows least privilege principles:
- ECR service roles for scanning operations
- Inspector roles for vulnerability analysis
- EventBridge permissions for event routing
- CloudWatch permissions for logging and alerting

### Network Security
- ECR repositories use encryption at rest
- VPC endpoints can be configured for private access
- Network ACLs and security groups control access

### Compliance
The solution supports:
- SOC 2 compliance requirements
- PCI DSS container security standards
- NIST Cybersecurity Framework controls
- AWS Well-Architected security pillar

## Troubleshooting

### Common Issues

1. **Inspector Not Enabled**:
   ```bash
   # Check Inspector status
   aws inspector2 get-configuration
   
   # Enable if needed
   aws inspector2 enable --resource-types ECR
   ```

2. **Scan Results Not Available**:
   ```bash
   # Verify repository scanning configuration
   aws ecr get-registry-scanning-configuration
   
   # Check image scan status
   aws ecr describe-image-scan-findings \
       --repository-name REPOSITORY_NAME \
       --image-id imageTag=TAG_NAME
   ```

3. **EventBridge Rules Not Triggering**:
   ```bash
   # Check rule status
   aws events describe-rule --name RULE_NAME
   
   # Verify rule targets
   aws events list-targets-by-rule --rule RULE_NAME
   ```

4. **SNS Notifications Not Received**:
   ```bash
   # Check subscription status
   aws sns list-subscriptions-by-topic --topic-arn TOPIC_ARN
   
   # Verify email confirmation
   aws sns get-subscription-attributes --subscription-arn SUBSCRIPTION_ARN
   ```

### Logs and Debugging

1. **CloudWatch Logs**:
   ```bash
   # View Inspector logs
   aws logs describe-log-groups --log-group-name-prefix "/aws/inspector"
   
   # View EventBridge logs
   aws logs describe-log-groups --log-group-name-prefix "/aws/events"
   ```

2. **CloudTrail Events**:
   ```bash
   # Review API calls
   aws logs filter-log-events \
       --log-group-name CloudTrail/Inspector \
       --start-time $(date -d '1 hour ago' +%s)000
   ```

## Cleanup

### Using CloudFormation
```bash
# Delete the stack
aws cloudformation delete-stack \
    --stack-name container-vulnerability-scanning

# Wait for deletion to complete
aws cloudformation wait stack-delete-complete \
    --stack-name container-vulnerability-scanning

# Verify deletion
aws cloudformation describe-stacks \
    --stack-name container-vulnerability-scanning 2>/dev/null || echo "Stack deleted"
```

### Using CDK TypeScript
```bash
cd cdk-typescript/

# Destroy the stack
cdk destroy

# Confirm when prompted
# Select 'y' to proceed with deletion
```

### Using CDK Python
```bash
cd cdk-python/

# Activate virtual environment
source .venv/bin/activate

# Destroy the stack
cdk destroy

# Confirm when prompted
# Select 'y' to proceed with deletion
```

### Using Terraform
```bash
cd terraform/

# Destroy all resources
terraform destroy

# Confirm when prompted
# Type 'yes' to proceed with deletion

# Clean up state files (optional)
rm -f terraform.tfstate*
```

### Using Bash Scripts
```bash
# Run the destroy script
./scripts/destroy.sh

# Confirm when prompted
# Follow the script prompts for safe deletion
```

### Manual Cleanup (if needed)
```bash
# Disable Inspector if no longer needed
aws inspector2 disable --resource-types ECR

# Delete any remaining ECR images
aws ecr list-images --repository-name REPOSITORY_NAME \
    --query 'imageIds[*]' --output json | \
    aws ecr batch-delete-image --repository-name REPOSITORY_NAME \
    --image-ids file:///dev/stdin

# Remove local Docker images
docker rmi $(docker images --filter "reference=*vulnerable*" -q) 2>/dev/null || true
```

## Cost Optimization

### Inspector Pricing
- Enhanced scanning: $0.09 per image scan
- Continuous monitoring: Additional charges for re-scanning
- Consider using basic scanning for development environments

### Storage Costs
- ECR storage: $0.10 per GB per month
- CloudWatch logs: $0.50 per GB ingested
- Use lifecycle policies to manage image retention

### Monitoring Recommendations
```bash
# Set up cost alerts
aws budgets create-budget \
    --account-id $(aws sts get-caller-identity --query Account --output text) \
    --budget file://cost-budget.json
```

## Additional Resources

- [Amazon ECR User Guide](https://docs.aws.amazon.com/AmazonECR/latest/userguide/)
- [Amazon Inspector User Guide](https://docs.aws.amazon.com/inspector/latest/user/)
- [Container Security Best Practices](https://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_best_practices.html)
- [AWS Well-Architected Security Pillar](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/)
- [EventBridge User Guide](https://docs.aws.amazon.com/eventbridge/latest/userguide/)

## Support

For issues with this infrastructure code:
1. Check the troubleshooting section above
2. Review AWS service status at https://status.aws.amazon.com/
3. Consult the original recipe documentation
4. Contact AWS Support for service-specific issues

## License

This infrastructure code is provided as-is for educational and demonstration purposes. Review and modify according to your organization's security and compliance requirements before production use.