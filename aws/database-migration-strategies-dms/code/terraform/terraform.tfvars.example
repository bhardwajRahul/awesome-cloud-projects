# AWS Database Migration Service (DMS) Example Configuration
# Copy this file to terraform.tfvars and customize the values for your environment

#############################################
# Required Variables
#############################################

# Project identification
project_name = "my-dms-migration"
owner        = "data-engineering-team"

# Network configuration - REQUIRED
# Either specify a VPC ID or leave empty to use default VPC
vpc_id = "vpc-12345678"

# Optional: Specify specific subnets (must be in different AZs)
# If not specified, will automatically select subnets from the VPC
subnet_ids = [
  "subnet-12345678",  # AZ-a
  "subnet-87654321"   # AZ-b
]

#############################################
# Environment Configuration
#############################################

environment  = "prod"
aws_region   = "us-west-2"
cost_center  = "data-platform"

#############################################
# DMS Replication Instance Configuration
#############################################

# Instance sizing - adjust based on workload requirements
replication_instance_class = "dms.r6i.large"  # 2 vCPU, 16 GB RAM
allocated_storage         = 200               # GB
multi_az                 = true               # High availability
engine_version           = "3.5.3"           # Latest stable version

# Maintenance and deployment settings
preferred_maintenance_window = "sun:03:00-sun:04:00"  # UTC
apply_immediately           = false                    # Apply changes during maintenance window
auto_minor_version_upgrade  = true                    # Auto-upgrade minor versions
publicly_accessible        = false                    # Private deployment

#############################################
# Source Database Configuration
#############################################

create_source_endpoint = true

# Database connection details
source_engine_name    = "postgres"
source_server_name    = "source-postgres.example.com"
source_port          = 5432
source_database_name = "production_db"

# Authentication (consider using Secrets Manager for production)
source_username = "dms_user"
source_password = "your_secure_password_here"  # Consider using Secrets Manager

# SSL configuration
source_ssl_mode = "require"

# PostgreSQL-specific settings
postgres_plugin_name     = "pglogical"
postgres_heartbeat_enable = true
postgres_max_file_size   = 32768

# Optional: Use Secrets Manager instead of plain text credentials
# source_secrets_manager_arn = "arn:aws:secretsmanager:us-west-2:123456789012:secret:dms-source-credentials-AbCdEf"

#############################################
# Target Database Configuration
#############################################

create_target_endpoint = true

# Database connection details
target_engine_name    = "postgres"
target_server_name    = "target-postgres.example.com"
target_port          = 5432
target_database_name = "migrated_db"

# Authentication (consider using Secrets Manager for production)
target_username = "dms_user"
target_password = "your_secure_password_here"  # Consider using Secrets Manager

# SSL configuration
target_ssl_mode = "require"

# Optional: Use Secrets Manager instead of plain text credentials
# target_secrets_manager_arn = "arn:aws:secretsmanager:us-west-2:123456789012:secret:dms-target-credentials-XyZabc"

#############################################
# Alternative Target: S3 Configuration
#############################################

# Uncomment and configure for S3 target endpoint
# target_engine_name = "s3"
# s3_bucket_folder   = "database-migration"
# s3_data_format     = "parquet"
# s3_compression_type = "GZIP"

#############################################
# Migration Task Configuration
#############################################

create_replication_task = true
migration_type         = "full-load-and-cdc"  # Options: full-load, cdc, full-load-and-cdc
start_replication_task = false                 # Set to true to auto-start after creation

# Table mapping - migrate all tables by default
table_mappings = jsonencode({
  "rules" = [
    {
      "rule-type"   = "selection"
      "rule-id"     = "1"
      "rule-name"   = "include-all-tables"
      "object-locator" = {
        "schema-name" = "%"
        "table-name"  = "%"
      }
      "rule-action" = "include"
    }
  ]
})

# Example: Selective table migration and transformation
# table_mappings = jsonencode({
#   "rules" = [
#     {
#       "rule-type"   = "selection"
#       "rule-id"     = "1"
#       "rule-name"   = "include-specific-schema"
#       "object-locator" = {
#         "schema-name" = "public"
#         "table-name"  = "%"
#       }
#       "rule-action" = "include"
#     },
#     {
#       "rule-type"   = "transformation"
#       "rule-id"     = "2"
#       "rule-name"   = "rename-schema"
#       "rule-target" = "schema"
#       "object-locator" = {
#         "schema-name" = "public"
#       }
#       "rule-action" = "rename"
#       "value"       = "migrated_public"
#     }
#   ]
# })

#############################################
# Security Configuration
#############################################

# KMS encryption
create_kms_key              = true
kms_deletion_window_in_days = 7

# IAM roles - create new roles (recommended for new deployments)
create_dms_vpc_role                     = true
create_dms_cloudwatch_logs_role        = true
create_dms_access_for_endpoint_role    = true

# S3 bucket for logs and migration data
create_s3_bucket = true

# Network security
source_database_cidr_blocks = ["10.0.0.0/8"]
target_database_cidr_blocks = ["10.0.0.0/8"]

# Database ports
source_database_ports = [5432]  # PostgreSQL
target_database_ports = [5432]  # PostgreSQL

#############################################
# Monitoring and Alerting Configuration
#############################################

enable_cloudwatch_alarms = true
log_retention_in_days   = 30

# CloudWatch alarm thresholds
cpu_alarm_threshold               = 80   # Percentage
memory_alarm_threshold           = 134217728  # 128 MB in bytes
replication_lag_alarm_threshold  = 300  # 5 minutes in seconds

# Optional: SNS topic for alarm notifications
# alarm_notification_arn = "arn:aws:sns:us-west-2:123456789012:dms-alerts"

#############################################
# Performance Tuning (Advanced)
#############################################

# Custom task settings for performance optimization
replication_task_settings = jsonencode({
  "TargetMetadata" = {
    "TargetSchema"                 = ""
    "SupportLobs"                  = true
    "FullLobMode"                  = false
    "LobChunkSize"                 = 0
    "LimitedSizeLobMode"           = true
    "LobMaxSize"                   = 32
    "InlineLobMaxSize"             = 0
    "LoadMaxFileSize"              = 0
    "ParallelLoadThreads"          = 8      # Increase for better performance
    "ParallelLoadBufferSize"       = 0
    "BatchApplyEnabled"            = true   # Enable for better performance
    "TaskRecoveryTableEnabled"     = false
    "ParallelApplyThreads"         = 4      # Parallel apply for CDC
    "ParallelApplyBufferSize"      = 1000
    "ParallelApplyQueuesPerThread" = 1
  }
  "FullLoadSettings" = {
    "TargetTablePrepMode"                 = "DROP_AND_CREATE"
    "CreatePkAfterFullLoad"               = false
    "StopTaskCachedChangesApplied"        = false
    "StopTaskCachedChangesNotApplied"     = false
    "MaxFullLoadSubTasks"                 = 8
    "TransactionConsistencyTimeout"       = 600
    "CommitRate"                          = 10000
  }
  "Logging" = {
    "EnableLogging" = true
    "LogComponents" = [
      {
        "Id"       = "TRANSFORMATION"
        "Severity" = "LOGGER_SEVERITY_DEFAULT"
      },
      {
        "Id"       = "SOURCE_UNLOAD"
        "Severity" = "LOGGER_SEVERITY_DEFAULT"
      },
      {
        "Id"       = "TARGET_LOAD"
        "Severity" = "LOGGER_SEVERITY_DEFAULT"
      },
      {
        "Id"       = "SOURCE_CAPTURE"
        "Severity" = "LOGGER_SEVERITY_DEFAULT"
      },
      {
        "Id"       = "TARGET_APPLY"
        "Severity" = "LOGGER_SEVERITY_DEFAULT"
      }
    ]
  }
  "ControlTablesSettings" = {
    "historyTimeslotInMinutes"            = 5
    "ControlSchema"                       = ""
    "HistoryTimeslotInMinutes"            = 5
    "HistoryTableEnabled"                 = false
    "SuspendedTablesTableEnabled"         = false
    "StatusTableEnabled"                  = false
    "FullLoadExceptionTableEnabled"       = false
  }
  "StreamBufferSettings" = {
    "StreamBufferCount"      = 3
    "StreamBufferSizeInMB"   = 8
    "CtrlStreamBufferSizeInMB" = 5
  }
  "ChangeProcessingDdlHandlingPolicy" = {
    "HandleSourceTableDropped"   = true
    "HandleSourceTableTruncated" = true
    "HandleSourceTableAltered"   = true
  }
  "ErrorBehavior" = {
    "DataErrorPolicy"                = "LOG_ERROR"
    "DataTruncationErrorPolicy"      = "LOG_ERROR"
    "DataErrorEscalationPolicy"      = "SUSPEND_TABLE"
    "DataErrorEscalationCount"       = 0
    "TableErrorPolicy"               = "SUSPEND_TABLE"
    "TableErrorEscalationPolicy"     = "STOP_TASK"
    "TableErrorEscalationCount"      = 0
    "RecoverableErrorCount"          = -1
    "RecoverableErrorInterval"       = 5
    "RecoverableErrorThrottling"     = true
    "RecoverableErrorThrottlingMax"  = 1800
    "RecoverableErrorStopRetryAfterThrottlingMax" = true
    "ApplyErrorDeletePolicy"         = "IGNORE_RECORD"
    "ApplyErrorInsertPolicy"         = "LOG_ERROR"
    "ApplyErrorUpdatePolicy"         = "LOG_ERROR"
    "ApplyErrorEscalationPolicy"     = "LOG_ERROR"
    "ApplyErrorEscalationCount"      = 0
    "ApplyErrorFailOnTruncationDdl"  = false
    "FullLoadIgnoreConflicts"        = true
    "FailOnTransactionConsistencyBreached" = false
    "FailOnNoTablesCaptured"         = true
  }
  "ChangeProcessingTuning" = {
    "BatchApplyPreserveTransaction" = true
    "BatchApplyTimeoutMin"          = 1
    "BatchApplyTimeoutMax"          = 30
    "BatchApplyMemoryLimit"         = 500
    "BatchSplitSize"                = 0
    "MinTransactionSize"            = 1000
    "CommitTimeout"                 = 1
    "MemoryLimitTotal"              = 1024
    "MemoryKeepTime"                = 60
    "StatementCacheSize"            = 50
  }
  "ValidationSettings" = {
    "EnableValidation"                 = true
    "ValidationMode"                   = "ROW_LEVEL"
    "ThreadCount"                      = 5
    "PartitionSize"                    = 10000
    "FailureMaxCount"                  = 10000
    "RecordFailureDelayInMinutes"      = 5
    "RecordSuspendDelayInMinutes"      = 30
    "MaxKeyColumnSize"                 = 8096
    "TableFailureMaxCount"             = 1000
    "ValidationOnly"                   = false
    "HandleCollationDiff"              = false
    "RecordFailureDelayLimitInMinutes" = 0
    "SkipLobColumns"                   = false
    "ValidationPartialLobSize"         = 0
    "ValidationQueryCdcDelaySeconds"   = 0
  }
  "PostProcessingRules" = null
  "CharacterSetSettings" = null
  "LoopbackPreventionSettings" = null
  "BeforeImageSettings" = null
})