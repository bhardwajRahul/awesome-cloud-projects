# Infrastructure Manager Configuration for Smart Calendar Intelligence
# This configuration deploys a complete calendar intelligence system using
# Google Cloud Calendar API, Cloud Run Worker Pools, Vertex AI, and Cloud Tasks

# Copyright 2025 Google LLC
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0

imports:
  - path: templates/worker-pool.jinja
  - path: templates/cloud-run-service.jinja
  - path: templates/bigquery-dataset.jinja

resources:
  # Project Configuration and APIs
  - name: project-services
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/calendar-json.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-run
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/run.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-tasks
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/cloudtasks.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-ai
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/aiplatform.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-bigquery
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/bigquery.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-storage
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/storage.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-artifactregistry
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/artifactregistry.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-cloudbuild
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/cloudbuild.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  - name: project-services-scheduler
    type: gcp-types/serviceusage-v1:services
    properties:
      name: projects/$(ref.project-id.name)/services/cloudscheduler.googleapis.com
      parent: projects/$(ref.project-id.name)
    metadata:
      dependsOn:
        - project-id

  # Service Account for Calendar Intelligence Worker
  - name: calendar-intelligence-worker-sa
    type: gcp-types/iam-v1:projects.serviceAccounts
    properties:
      parent: projects/$(ref.project-id.name)
      serviceAccount:
        accountId: calendar-intelligence-worker
        displayName: Calendar Intelligence Worker Service Account
        description: Service account for calendar intelligence worker pool operations
    metadata:
      dependsOn:
        - project-id

  # IAM Bindings for Worker Service Account
  - name: worker-sa-aiplatform-binding
    type: gcp-types/cloudresourcemanager-v1:virtual.projects.iamMemberBinding
    properties:
      resource: $(ref.project-id.name)
      role: roles/aiplatform.user
      member: serviceAccount:$(ref.calendar-intelligence-worker-sa.email)
    metadata:
      dependsOn:
        - calendar-intelligence-worker-sa

  - name: worker-sa-bigquery-binding
    type: gcp-types/cloudresourcemanager-v1:virtual.projects.iamMemberBinding
    properties:
      resource: $(ref.project-id.name)
      role: roles/bigquery.dataEditor
      member: serviceAccount:$(ref.calendar-intelligence-worker-sa.email)
    metadata:
      dependsOn:
        - calendar-intelligence-worker-sa

  - name: worker-sa-storage-binding
    type: gcp-types/cloudresourcemanager-v1:virtual.projects.iamMemberBinding
    properties:
      resource: $(ref.project-id.name)
      role: roles/storage.objectAdmin
      member: serviceAccount:$(ref.calendar-intelligence-worker-sa.email)
    metadata:
      dependsOn:
        - calendar-intelligence-worker-sa

  - name: worker-sa-tasks-binding
    type: gcp-types/cloudresourcemanager-v1:virtual.projects.iamMemberBinding
    properties:
      resource: $(ref.project-id.name)
      role: roles/cloudtasks.enqueuer
      member: serviceAccount:$(ref.calendar-intelligence-worker-sa.email)
    metadata:
      dependsOn:
        - calendar-intelligence-worker-sa

  # Cloud Storage Bucket for Model Artifacts and Data
  - name: calendar-intelligence-bucket
    type: gcp-types/storage-v1:buckets
    properties:
      name: calendar-intelligence-$(ref.project-id.name)
      project: $(ref.project-id.name)
      location: us-central1
      storageClass: STANDARD
      versioning:
        enabled: true
      encryption:
        defaultKmsKeyName: ""
      uniformBucketLevelAccess:
        enabled: true
      publicAccessPrevention: enforced
      labels:
        purpose: calendar-intelligence
        environment: production
        component: storage
    metadata:
      dependsOn:
        - project-services-storage

  # Artifact Registry Repository for Container Images
  - name: calendar-intelligence-repo
    type: gcp-types/artifactregistry-v1:projects.locations.repositories
    properties:
      parent: projects/$(ref.project-id.name)/locations/us-central1
      repositoryId: calendar-intelligence
      repository:
        format: DOCKER
        description: Calendar intelligence container repository with vulnerability scanning
        labels:
          purpose: calendar-intelligence
          environment: production
          component: container-registry
    metadata:
      dependsOn:
        - project-services-artifactregistry

  # BigQuery Dataset for Analytics
  - name: calendar-analytics-dataset
    type: gcp-types/bigquery-v2:datasets
    properties:
      projectId: $(ref.project-id.name)
      datasetId: calendar_analytics_$(env.RANDOM_SUFFIX)
      dataset:
        friendlyName: Calendar Intelligence Analytics Dataset
        description: Dataset for storing calendar intelligence insights and analytics
        location: us-central1
        defaultTableExpirationMs: "7776000000"  # 90 days
        labels:
          purpose: calendar-intelligence
          environment: production
          component: analytics
        access:
          - role: OWNER
            userByEmail: $(ref.calendar-intelligence-worker-sa.email)
          - role: READER
            specialGroup: projectReaders
    metadata:
      dependsOn:
        - project-services-bigquery
        - calendar-intelligence-worker-sa

  # BigQuery Table for Calendar Insights
  - name: calendar-insights-table
    type: gcp-types/bigquery-v2:tables
    properties:
      projectId: $(ref.project-id.name)
      datasetId: $(ref.calendar-analytics-dataset.datasetReference.datasetId)
      tableId: calendar_insights
      table:
        friendlyName: Calendar Intelligence Insights
        description: Table storing AI-generated calendar insights and recommendations
        schema:
          fields:
            - name: calendar_id
              type: STRING
              mode: REQUIRED
              description: Unique identifier for the calendar being analyzed
            - name: analysis_timestamp
              type: TIMESTAMP
              mode: REQUIRED
              description: Timestamp when the analysis was performed
            - name: insights
              type: STRING
              mode: NULLABLE
              description: JSON string containing AI-generated insights and recommendations
            - name: processed_date
              type: DATE
              mode: REQUIRED
              description: Date when the calendar data was processed
            - name: meeting_count
              type: INTEGER
              mode: NULLABLE
              description: Total number of meetings analyzed
            - name: optimization_score
              type: FLOAT
              mode: NULLABLE
              description: AI-calculated optimization score (0-100)
        labels:
          purpose: calendar-intelligence
          component: insights-storage
        timePartitioning:
          type: DAY
          field: processed_date
        clustering:
          fields:
            - calendar_id
            - processed_date
    metadata:
      dependsOn:
        - calendar-analytics-dataset

  # Cloud Tasks Queue for Job Distribution
  - name: calendar-tasks-queue
    type: gcp-types/cloudtasks-v2:projects.locations.queues
    properties:
      parent: projects/$(ref.project-id.name)/locations/us-central1
      queue:
        name: calendar-tasks-$(env.RANDOM_SUFFIX)
        state: RUNNING
        rateLimits:
          maxDispatchesPerSecond: 5.0
          maxConcurrentDispatches: 10
          maxBurstSize: 20
        retryConfig:
          maxAttempts: 3
          maxRetryDuration: 3600s
          maxBackoff: 300s
          minBackoff: 1s
          maxDoublings: 5
        labels:
          purpose: calendar-intelligence
          environment: production
          component: task-distribution
    metadata:
      dependsOn:
        - project-services-tasks

  # Cloud Run Service for API Endpoints
  - name: calendar-intelligence-api
    type: gcp-types/run-v1:namespaces.services
    properties:
      parent: namespaces/$(ref.project-id.name)
      location: us-central1
      service:
        apiVersion: serving.knative.dev/v1
        kind: Service
        metadata:
          name: calendar-intelligence-api
          namespace: $(ref.project-id.name)
          labels:
            purpose: calendar-intelligence
            component: api-service
            environment: production
          annotations:
            run.googleapis.com/ingress: all
            run.googleapis.com/execution-environment: gen2
        spec:
          template:
            metadata:
              labels:
                purpose: calendar-intelligence
                component: api-service
              annotations:
                autoscaling.knative.dev/minScale: "0"
                autoscaling.knative.dev/maxScale: "5"
                run.googleapis.com/memory: "1Gi"
                run.googleapis.com/cpu: "1"
                run.googleapis.com/execution-environment: gen2
            spec:
              serviceAccountName: $(ref.calendar-intelligence-worker-sa.email)
              containerConcurrency: 80
              timeoutSeconds: 300
              containers:
                - name: api-container
                  image: us-central1-docker.pkg.dev/$(ref.project-id.name)/calendar-intelligence/api:latest
                  ports:
                    - name: http1
                      containerPort: 8080
                      protocol: TCP
                  env:
                    - name: GOOGLE_CLOUD_PROJECT
                      value: $(ref.project-id.name)
                    - name: GOOGLE_CLOUD_REGION
                      value: us-central1
                    - name: TASK_QUEUE_NAME
                      value: $(ref.calendar-tasks-queue.name)
                    - name: DATASET_NAME
                      value: $(ref.calendar-analytics-dataset.datasetReference.datasetId)
                  resources:
                    limits:
                      memory: 1Gi
                      cpu: 1000m
                    requests:
                      memory: 512Mi
                      cpu: 500m
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 8080
                    initialDelaySeconds: 30
                    periodSeconds: 30
                    timeoutSeconds: 10
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /health
                      port: 8080
                    initialDelaySeconds: 10
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 3
          traffic:
            - percent: 100
              latestRevision: true
    metadata:
      dependsOn:
        - project-services-run
        - calendar-intelligence-worker-sa
        - calendar-tasks-queue
        - calendar-analytics-dataset

  # Cloud Run Worker Pool for Background Processing
  - name: calendar-intelligence-worker-pool
    type: gcp-types/run-v1:namespaces.services
    properties:
      parent: namespaces/$(ref.project-id.name)
      location: us-central1
      service:
        apiVersion: serving.knative.dev/v1
        kind: Service
        metadata:
          name: calendar-intelligence-worker-$(env.RANDOM_SUFFIX)
          namespace: $(ref.project-id.name)
          labels:
            purpose: calendar-intelligence
            component: worker-pool
            environment: production
          annotations:
            run.googleapis.com/ingress: internal
            run.googleapis.com/execution-environment: gen2
            run.googleapis.com/launch-stage: BETA
        spec:
          template:
            metadata:
              labels:
                purpose: calendar-intelligence
                component: worker-pool
              annotations:
                autoscaling.knative.dev/minScale: "0"
                autoscaling.knative.dev/maxScale: "10"
                run.googleapis.com/memory: "2Gi"
                run.googleapis.com/cpu: "1"
                run.googleapis.com/execution-environment: gen2
            spec:
              serviceAccountName: $(ref.calendar-intelligence-worker-sa.email)
              containerConcurrency: 1
              timeoutSeconds: 3600
              containers:
                - name: worker-container
                  image: us-central1-docker.pkg.dev/$(ref.project-id.name)/calendar-intelligence/worker:latest
                  env:
                    - name: GOOGLE_CLOUD_PROJECT
                      value: $(ref.project-id.name)
                    - name: GOOGLE_CLOUD_REGION
                      value: us-central1
                    - name: DATASET_NAME
                      value: $(ref.calendar-analytics-dataset.datasetReference.datasetId)
                    - name: BUCKET_NAME
                      value: $(ref.calendar-intelligence-bucket.name)
                    - name: TASK_QUEUE_NAME
                      value: $(ref.calendar-tasks-queue.name)
                  resources:
                    limits:
                      memory: 2Gi
                      cpu: 1000m
                    requests:
                      memory: 1Gi
                      cpu: 500m
                  volumeMounts:
                    - name: service-account-volume
                      mountPath: /app/service-account.json
                      subPath: service-account.json
                      readOnly: true
              volumes:
                - name: service-account-volume
                  secret:
                    secretName: calendar-intelligence-sa-key
                    items:
                      - key: service-account.json
                        path: service-account.json
          traffic:
            - percent: 100
              latestRevision: true
    metadata:
      dependsOn:
        - project-services-run
        - calendar-intelligence-worker-sa
        - calendar-analytics-dataset
        - calendar-intelligence-bucket
        - calendar-tasks-queue

  # Cloud Scheduler Job for Daily Analysis
  - name: calendar-daily-analysis-job
    type: gcp-types/cloudscheduler-v1:projects.locations.jobs
    properties:
      parent: projects/$(ref.project-id.name)/locations/us-central1
      job:
        name: calendar-daily-analysis
        description: Daily calendar intelligence analysis scheduler
        schedule: "0 9 * * *"  # 9 AM daily
        timeZone: "America/New_York"
        attemptDeadline: 600s
        retryConfig:
          retryCount: 3
          maxRetryDuration: 300s
          minBackoffDuration: 5s
          maxBackoffDuration: 60s
          maxDoublings: 3
        httpTarget:
          uri: $(ref.calendar-intelligence-api.status.url)/trigger-analysis
          httpMethod: POST
          headers:
            Content-Type: application/json
            User-Agent: Google-Cloud-Scheduler
          body: |
            {
              "calendar_ids": ["primary"],
              "analysis_type": "daily",
              "include_recommendations": true
            }
          oidcToken:
            serviceAccountEmail: $(ref.calendar-intelligence-worker-sa.email)
            audience: $(ref.calendar-intelligence-api.status.url)
        labels:
          purpose: calendar-intelligence
          component: scheduler
          environment: production
    metadata:
      dependsOn:
        - project-services-scheduler
        - calendar-intelligence-api
        - calendar-intelligence-worker-sa

  # Monitoring and Alerting Configuration
  - name: calendar-intelligence-log-metric
    type: gcp-types/logging-v2:projects.metrics
    properties:
      parent: projects/$(ref.project-id.name)
      metric:
        name: calendar_intelligence_errors
        description: Calendar intelligence processing errors
        filter: >
          resource.type="cloud_run_revision"
          resource.labels.service_name=~"calendar-intelligence.*"
          severity>=ERROR
        labelExtractors:
          service_name: EXTRACT(resource.labels.service_name)
          error_type: EXTRACT(jsonPayload.error_type)
        metricDescriptor:
          metricKind: COUNTER
          valueType: INT64
          displayName: Calendar Intelligence Errors
          description: Count of calendar intelligence processing errors
          labels:
            - key: service_name
              valueType: STRING
            - key: error_type
              valueType: STRING
    metadata:
      dependsOn:
        - calendar-intelligence-api
        - calendar-intelligence-worker-pool

  # Vertex AI Endpoint for Custom Models (Optional)
  - name: calendar-intelligence-endpoint
    type: gcp-types/aiplatform-v1:projects.locations.endpoints
    properties:
      parent: projects/$(ref.project-id.name)/locations/us-central1
      endpoint:
        displayName: Calendar Intelligence Endpoint
        description: Vertex AI endpoint for calendar intelligence models
        labels:
          purpose: calendar-intelligence
          component: ai-endpoint
          environment: production
        encryptionSpec:
          kmsKeyName: ""
        enablePrivateServiceConnect: false
    metadata:
      dependsOn:
        - project-services-ai

outputs:
  # Project and Service Information
  - name: project-id
    value: $(ref.project-id.name)
    description: Google Cloud Project ID for the calendar intelligence system

  - name: region
    value: us-central1
    description: Primary region for calendar intelligence resources

  # API and Service URLs
  - name: api-service-url
    value: $(ref.calendar-intelligence-api.status.url)
    description: URL for the calendar intelligence API service

  - name: worker-pool-name
    value: $(ref.calendar-intelligence-worker-pool.metadata.name)
    description: Name of the calendar intelligence worker pool

  # Storage and Analytics
  - name: storage-bucket-name
    value: $(ref.calendar-intelligence-bucket.name)
    description: Cloud Storage bucket for calendar intelligence artifacts

  - name: bigquery-dataset-id
    value: $(ref.calendar-analytics-dataset.datasetReference.datasetId)
    description: BigQuery dataset ID for calendar analytics

  - name: bigquery-table-id
    value: calendar_insights
    description: BigQuery table ID for calendar insights

  # Task Processing
  - name: task-queue-name
    value: $(ref.calendar-tasks-queue.name)
    description: Cloud Tasks queue name for calendar processing jobs

  - name: scheduler-job-name
    value: calendar-daily-analysis
    description: Cloud Scheduler job name for daily analysis

  # Container Registry
  - name: artifact-registry-repo
    value: us-central1-docker.pkg.dev/$(ref.project-id.name)/calendar-intelligence
    description: Artifact Registry repository URL for container images

  # Service Account
  - name: worker-service-account-email
    value: $(ref.calendar-intelligence-worker-sa.email)
    description: Service account email for calendar intelligence workers

  # AI and ML
  - name: vertex-ai-endpoint-name
    value: $(ref.calendar-intelligence-endpoint.name)
    description: Vertex AI endpoint name for custom models

  # Monitoring
  - name: log-metric-name
    value: calendar_intelligence_errors
    description: Log-based metric name for monitoring errors

# Template Variables
properties:
  # Project Configuration
  - name: project-id
    type: string
    description: Google Cloud Project ID
    default: calendar-ai-project

  - name: random-suffix
    type: string
    description: Random suffix for unique resource naming
    default: "001"

  # Resource Configuration
  - name: region
    type: string
    description: Primary Google Cloud region
    default: us-central1
    allowedValues:
      - us-central1
      - us-east1
      - us-west1
      - europe-west1
      - asia-east1

  - name: worker-pool-max-instances
    type: integer
    description: Maximum number of worker pool instances
    default: 10
    minimum: 1
    maximum: 100

  - name: api-service-max-instances
    type: integer
    description: Maximum number of API service instances
    default: 5
    minimum: 1
    maximum: 50

  # Scheduling Configuration
  - name: analysis-schedule
    type: string
    description: Cron schedule for daily calendar analysis
    default: "0 9 * * *"

  - name: analysis-timezone
    type: string
    description: Timezone for scheduled analysis
    default: "America/New_York"

  # BigQuery Configuration
  - name: table-expiration-days
    type: integer
    description: Default table expiration in days
    default: 90
    minimum: 1
    maximum: 365

  # Security Configuration
  - name: enable-vpc-connector
    type: boolean
    description: Enable VPC connector for enhanced security
    default: false

  - name: enable-binary-authorization
    type: boolean
    description: Enable Binary Authorization for container security
    default: false

# Environment Variables for Template Processing
env:
  RANDOM_SUFFIX: $(ref.random-suffix)
  PROJECT_ID: $(ref.project-id)
  REGION: $(ref.region)
  ANALYSIS_SCHEDULE: $(ref.analysis-schedule)
  ANALYSIS_TIMEZONE: $(ref.analysis-timezone)

# Metadata and Documentation
metadata:
  version: "1.0"
  description: "Google Cloud Infrastructure Manager configuration for Smart Calendar Intelligence system"
  author: "Google Cloud Solutions Architecture"
  license: "Apache 2.0"
  created: "2025-07-12"
  updated: "2025-07-12"
  
  tags:
    - calendar-intelligence
    - cloud-run-worker-pools
    - vertex-ai
    - cloud-tasks
    - bigquery-analytics
    - serverless-architecture
    - ai-automation
    - productivity-optimization
  
  documentation:
    architecture: "Serverless calendar intelligence system using Cloud Run Worker Pools for background processing"
    deployment: "Deploy using Google Cloud Infrastructure Manager with appropriate IAM permissions"
    monitoring: "Includes Cloud Monitoring integration and custom log-based metrics"
    security: "Implements least privilege IAM, private service communication, and encryption at rest"
    
  dependencies:
    - google-cloud-calendar-api
    - cloud-run-worker-pools
    - vertex-ai-platform
    - cloud-tasks-service
    - bigquery-analytics
    - artifact-registry
    - cloud-scheduler
    - cloud-monitoring